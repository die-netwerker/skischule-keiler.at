import{E as f}from"./main-DLOZxWIX.js";import"./store-Dh7w5eyu.js";import"./channel-D6fkBpuJ.js";import"./administration-BkFWn-Oy.js";const b=`{% block sw_product_detail %} <sw-page class="sw-product-detail"> {% block sw_product_detail_header %} <template #smart-bar-header> <h2> <sw-product-variant-info :variations="product.variation" :title-term="productTitle" > {{ productTitle }} </sw-product-variant-info> </h2> </template> {% endblock %} {% block sw_product_detail_actions %} <template #smart-bar-actions> {% block sw_product_detail_actions_abort %} <mt-button v-tooltip.bottom="tooltipCancel" :disabled="isLoading" variant="secondary" size="default" @click="onCancel" > {{ $tc('global.default.cancel') }} </mt-button> {% endblock %} <sw-button-group v-tooltip.bottom="{ message: $tc('sw-privileges.tooltip.warning'), disabled: acl.can('product.editor'), showOnDisabledElements: true }" class="sw-product-detail__save-button-group" :split-button="true" > {% block sw_product_detail_actions_save %} <sw-button-process v-tooltip.bottom="tooltipSave" class="sw-product-detail__save-action" :is-loading="isLoading" :process-success="isSaveSuccessful" variant="primary" :disabled="isLoading || !acl.can('product.editor')" size="default" @update:process-success="saveFinish" @click.prevent="onSave" > {{ $tc('sw-product.detail.buttonSave') }} </sw-button-process> {% endblock %} {% block sw_product_detail_actions_save_context_menu %} <sw-context-button> <template #button> <mt-button class="sw-product-detail__button-context-menu" square variant="primary" :disabled="isLoading || !acl.can('product.editor')" size="default" > <mt-icon name="regular-chevron-down-xs" size="16" /> </mt-button> </template> {% block sw_product_detail_actions_save_context_menu_actions %} {% block sw_product_detail_actions_duplicate %} <sw-context-menu-item class="sw-product-detail__save-duplicate-action" :disabled="!acl.can('product.creator') || !acl.can('product.editor') || product.parentId != null" @click="onDuplicate" > {{ $tc('sw-product.detail.buttonSaveDuplicate') }} </sw-context-menu-item> {% endblock %} {% endblock %} </sw-context-button> {% endblock %} </sw-button-group> </template> {% endblock %} {% block sw_product_detail_language_switch %} <template #language-switch> <sw-language-switch :save-changes-function="saveOnLanguageChange" :abort-change-function="abortOnLanguageChange" :disabled="!productId" @on-change="onChangeLanguage" /> </template> {% endblock %} {% block sw_product_detail_content %} <template #content> <sw-card-view> {% block sw_product_detail_content_top %} <template v-if="!isLoading && isChild"> <router-link v-if="advanceModeEnabled" class="sw-card__back-link" :to="{ name: 'sw.product.detail.variants', params: { id: product.parentId } }" > <mt-icon name="regular-long-arrow-left" size="16px" /> {{ $tc('sw-product.general.backToParent') }} </router-link> <router-link v-else class="sw-card__back-link" :to="{ name: 'sw.product.detail.base', params: { id: product.parentId } }" > <mt-icon name="regular-long-arrow-left" size="16px" /> {{ $tc('sw-product.general.backToGeneralOverview') }} </router-link> </template> {% endblock %} {% block sw_product_detail_content_language_info %} <sw-language-info :entity-description="placeholder(product, 'name', $tc('sw-product.detail.textHeadline'))" :is-new-entity="!productId" /> {% endblock %} {% block sw_product_detail_inheritance_warning %} <sw-inheritance-warning v-if="isChild" :name="$tc('sw-product.general.inheritanceModuleName')" /> {% endblock %} {% block sw_product_detail_content_tabs %} <sw-tabs v-if="productId" class="sw-product-detail-page__tabs" position-identifier="sw-product-detail" > {% block sw_product_detail_content_tabs_general %} <sw-tabs-item class="sw-product-detail__tab-general" :route="{ name: 'sw.product.detail.base', params: { id: $route.params.id } }" :has-error="swProductDetailBaseError" :title="$tc('sw-product.detail.tabGeneral')" > {{ $tc('sw-product.detail.tabGeneral') }} </sw-tabs-item> {% endblock %} {% block sw_product_detail_content_tabs_specifications %} <sw-tabs-item class="sw-product-detail__tab-specifications" :route="{ name: 'sw.product.detail.specifications', params: { id: $route.params.id } }" :title="$tc('sw-product.detail.tabSpecifications')" > {{ $tc('sw-product.detail.tabSpecifications') }} </sw-tabs-item> {% endblock %} {% block sw_product_detail_content_tabs_advanced_prices %} <sw-tabs-item v-show="showModeSetting" class="sw-product-detail__tab-advanced-prices" :route="{ name: 'sw.product.detail.prices', params: { id: $route.params.id } }" :title="$tc('sw-product.detail.tabAdvancedPrices')" > {{ $tc('sw-product.detail.tabAdvancedPrices') }} </sw-tabs-item> {% endblock %} {% block sw_product_detail_content_tabs_advanced_variants %} <sw-tabs-item v-show="!isChild && showModeSetting" class="sw-product-detail__tab-variants" :route="{ name: 'sw.product.detail.variants', params: { id: $route.params.id } }" :title="$tc('sw-product.detail.tabVariation')" > {{ $tc('sw-product.detail.tabVariation') }} </sw-tabs-item> {% endblock %} {% block sw_product_detail_content_tabs_layout %} <sw-tabs-item v-show="!isChild && showModeSetting" class="sw-product-detail__tab-layout" :route="{ name: 'sw.product.detail.layout', params: { id: $route.params.id } }" :title="$tc('sw-product.detail.tabLayout')" > {{ $tc('sw-product.detail.tabLayout') }} </sw-tabs-item> {% endblock %} {% block sw_product_detail_content_tabs_seo %} <sw-tabs-item v-show="showModeSetting" class="sw-product-detail__tab-seo" :route="{ name: 'sw.product.detail.seo', params: { id: $route.params.id } }" :title="$tc('sw-product.detail.tabSeo')" > {{ $tc('sw-product.detail.tabSeo') }} </sw-tabs-item> {% endblock %} {% block sw_product_detail_content_tabs_cross_selling %} <sw-tabs-item v-show="showModeSetting" class="sw-product-detail__tab-cross-selling" :route="{ name: 'sw.product.detail.crossSelling', params: { id: $route.params.id } }" :has-error="swProductDetailCrossSellingError" :title="$tc('sw-product.detail.tabCrossSelling')" > {{ $tc('sw-product.detail.tabCrossSelling') }} </sw-tabs-item> {% endblock %} {% block sw_product_detail_content_tabs_reviews %} <sw-tabs-item v-show="showModeSetting" class="sw-product-detail__tab-reviews" :route="{ name: 'sw.product.detail.reviews', params: { id: $route.params.id } }" :title="$tc('sw-product.detail.tabReviews')" > {{ $tc('sw-product.detail.tabReviews') }} </sw-tabs-item> {% endblock %} {% block sw_product_detail_content_tabs_additional %} {% endblock %} </sw-tabs> {% endblock %} <sw-extension-component-section position-identifier="sw-product-detail__before-content" /> {% block sw_product_detail_content_view %} <router-view v-slot="{ Component }" > <component :is="Component" @cover-change="onCoverChange" /> </router-view> {% endblock %} {% block sw_product_detail_content_clone_modal %} <sw-product-clone-modal v-if="cloning" :product="product" @clone-finish="onDuplicateFinish" /> {% endblock %} {% block sw_product_settings_mode %} <sw-product-settings-mode v-if="showAdvanceModeSetting" :is-loading="isLoading" :mode-settings="advancedModeSetting" @settings-item-change="onChangeSettingItem" @settings-change="onChangeSetting" /> {% endblock %} </sw-card-view> </template> {% endblock %} <template #sidebar> {% block sw_product_detail_sidebar %} {% endblock %} </template> </sw-page> {% endblock %}`,v={"sw.product.detail.base":{product:["taxId","price","stock","manufacturerId","name","downloads"]},"sw.product.detail.cross.selling":{product_cross_selling:["name","type","position"]}},{Context:y,Mixin:p,EntityDefinition:_}=Shopware,{Criteria:a,ChangesetGenerator:P}=Shopware.Data,{cloneDeep:c}=Shopware.Utils.object,{mapPageErrors:C}=Shopware.Component.getComponentHelper(),n=Shopware.Utils.types,x={template:b,inject:["mediaService","repositoryFactory","numberRangeService","seoUrlService","acl","systemConfigApiService","entityValidationService","userConfigService"],provide(){return{swProductDetailLoadAll:this.loadAll}},mixins:[p.getByName("notification"),p.getByName("placeholder")],shortcuts:{"SYSTEMKEY+S":{active(){return this.acl.can("product.editor")},method:"onSave"},ESCAPE:"onCancel"},props:{productId:{type:String,required:!1,default:null},creationStates:{type:Array,required:!1,default:null}},data(){return{productNumberPreview:"",isSaveSuccessful:!1,cloning:!1,defaultSalesChannelVisibility:30,previousLengthUnit:null,previousWeightUnit:null,updateSeoPromises:[]}},metaInfo(){return{title:this.$createTitle(this.identifier)}},computed:{product(){return Shopware.Store.get("swProductDetail").product},parentProduct(){return Shopware.Store.get("swProductDetail").parentProduct},localMode(){return Shopware.Store.get("swProductDetail").localMode},advancedModeSetting(){return Shopware.Store.get("swProductDetail").advancedModeSetting},modeSettings(){return Shopware.Store.get("swProductDetail").modeSettings},isLoading(){return Shopware.Store.get("swProductDetail").isLoading},isChild(){return Shopware.Store.get("swProductDetail").isChild},defaultCurrency(){return Shopware.Store.get("swProductDetail").defaultCurrency},getDefaultFeatureSet(){return Shopware.Store.get("swProductDetail").getDefaultFeatureSet},showModeSetting(){return Shopware.Store.get("swProductDetail").showModeSetting},advanceModeEnabled(){return Shopware.Store.get("swProductDetail").advanceModeEnabled},productStates(){return Shopware.Store.get("swProductDetail").productStates},...C(v),identifier(){return this.productTitle},productTitle(){return this.isChild&&this.product?this.getInheritTitle():this.$i18n?this.placeholder(this.product,"name",this.$tc("sw-product.detail.textHeadline")):""},productRepository(){return this.repositoryFactory.create("product")},propertyRepository(){return this.repositoryFactory.create("property_group_option")},syncRepository(){return this.repositoryFactory.create("product",null,{useSync:!0})},currencyRepository(){return this.repositoryFactory.create("currency")},taxRepository(){return this.repositoryFactory.create("tax")},customFieldSetRepository(){return this.repositoryFactory.create("custom_field_set")},salesChannelRepository(){return this.repositoryFactory.create("sales_channel")},productVisibilityRepository(){return this.repositoryFactory.create("product_visibility")},mediaRepository(){return this.product&&this.product.media?this.repositoryFactory.create(this.product.media.entity,this.product.media.source):null},featureSetRepository(){return this.repositoryFactory.create("product_feature_set")},currentUser(){return Shopware.Store.get("session").currentUser},userModeSettingsRepository(){return this.repositoryFactory.create("user_config")},userModeSettingsCriteria(){const t=new a(1,25);return t.addFilter(a.equals("key","mode.setting.advancedModeSettings")),t.addFilter(a.equals("userId",this.currentUser&&this.currentUser.id)),t},productCriteria(){const t=new a(1,1);return t.setTotalCountMode(0),t.getAssociation("media").addSorting(a.sort("position","ASC")),t.addAssociation("media.media"),t.getAssociation("prices").addSorting(a.sort("quantityStart","ASC",!0)),t.getAssociation("tags").addSorting(a.sort("name","ASC")),t.getAssociation("seoUrls").addFilter(a.equals("isCanonical",!0)),t.getAssociation("crossSellings").addSorting(a.sort("position","ASC")).getAssociation("assignedProducts").addSorting(a.sort("position","ASC")).addAssociation("product").getAssociation("product").addAssociation("options.group"),t.addAssociation("cover.media").addAssociation("categories").addAssociation("visibilities.salesChannel").addAssociation("options").addAssociation("configuratorSettings.option").addAssociation("unit").addAssociation("productReviews").addAssociation("seoUrls").addAssociation("mainCategories").addAssociation("options.group").addAssociation("customFieldSets").addAssociation("featureSet").addAssociation("cmsPage").addAssociation("featureSet").addAssociation("downloads.media"),t.getAssociation("manufacturer").addAssociation("media"),t},customFieldSetCriteria(){const t=new a(1,null);return t.addFilter(a.equals("relations.entityName","product")),t.addSorting(a.sort("config.customFieldPosition","ASC",!0)),t},defaultFeatureSetCriteria(){const t=new a(1,1);return t.addSorting(a.sort("createdAt","ASC")).addFilter(a.equalsAny("name",["Default","Standard"])),t},taxCriteria(){const t=new a(1,500);return t.addSorting(a.sort("position")),t},tooltipSave(){return{message:`${this.$device.getSystemKey()} + S`,appearance:"light"}},tooltipCancel(){return{message:"ESC",appearance:"light"}},getModeSettingGeneralTab(){return[{key:"general_information",label:"sw-product.detailBase.cardTitleProductInfo",enabled:!0,name:"general"},{key:"prices",label:"sw-product.detailBase.cardTitlePrices",enabled:!0,name:"general"},{key:"deliverability",label:"sw-product.detailBase.cardTitleDeliverabilityInfo",enabled:!0,name:"general"},{key:"visibility_structure",label:"sw-product.detailBase.cardTitleAssignment",enabled:!0,name:"general"},{key:"media",label:"sw-product.detailBase.cardTitleMedia",enabled:!0,name:"general"},{key:"labelling",label:"sw-product.detailBase.cardTitleSettings",enabled:!0,name:"general"}]},getModeSettingSpecificationsTab(){return[{key:"measurement",label:"sw-product.specifications.cardTitleMeasurement",enabled:!0,name:"specifications"},{key:"selling_packaging",label:"sw-product.specifications.cardTitleSellingPackaging",enabled:!0,name:"specifications"},{key:"properties",label:"sw-product.specifications.cardTitleProperties",enabled:!0,name:"specifications"},{key:"essential_characteristics",label:"sw-product.specifications.cardTitleEssentialCharacteristics",enabled:!0,name:"specifications"},{key:"custom_fields",label:"sw-product.specifications.cardTitleCustomFields",enabled:!0,name:"specifications"}]},showAdvanceModeSetting(){return this.isChild?!1:["sw.product.detail.base","sw.product.detail.specifications"].includes(this.$route.name)},cmsPageState(){return Shopware.Store.get("cmsPage")},currentPage(){return Shopware.Store.get("cmsPage").currentPage},languageRepository(){return this.repositoryFactory.create("language")},language(){return Shopware.Store.get("context").api.language},translateFields(){return this.product?Object.keys(_.getTranslatedFields(this.product.getEntityName())):null},ignoreFieldsValidation(){var e;if(!((e=this.language)!=null&&e.parentId))return[];const t={...this.product};return(this.translateFields||[]).filter(r=>{const i=t[r];return i==null||i===""})},productApiContext(){return{...Shopware.Context.api,measurementWeightUnit:this.weightUnit,measurementLengthUnit:this.lengthUnit}},lengthUnit(){return Shopware.Store.get("swProductDetail").lengthUnit},weightUnit(){return Shopware.Store.get("swProductDetail").weightUnit},measurementUnitsChanged(){return this.previousWeightUnit!==this.weightUnit||this.previousLengthUnit!==this.lengthUnit}},watch:{productId(){this.createdComponent()}},created(){this.createdComponent()},beforeRouteLeave(){Shopware.Store.get("shopwareApps").selectedIds=[]},methods:{async createdComponent(){Shopware.ExtensionAPI.publishData({id:"sw-product-detail__product",path:"product",scope:this}),Shopware.ExtensionAPI.publishData({id:"sw-product-detail__cmsPage",path:"currentPage",scope:this}),this.cmsPageState.resetCmsPageState(),this.productId||Shopware.Store.get("context").isSystemDefaultLanguage||Shopware.Store.get("context").resetLanguageToDefault(),await this.initProductMeasurementUnits(),this.initState(),this.initAdvancedModeSettings()},initState(){return Shopware.Store.get("swProductDetail").apiContext=Shopware.Context.api,this.productId?this.loadState():this.createState().then(()=>{this.numberRangeService.reserve("product","",!0).then(t=>{this.productNumberPreview=t.number,this.product.productNumber=t.number})})},initAdvancedModeSettings(){Shopware.Store.get("swProductDetail").advancedModeSetting=this.getAdvancedModeDefaultSetting(),this.getAdvancedModeSetting()},createUserModeSetting(){const t=this.userModeSettingsRepository.create();return t.key="mode.setting.advancedModeSettings",t.userId=this.currentUser&&this.currentUser.id,t},getAdvancedModeDefaultSetting(){const t=this.createUserModeSetting();return t.value={advancedMode:{label:"sw-product.general.textAdvancedMode",enabled:!0},settings:[...this.getModeSettingGeneralTab,...this.getModeSettingSpecificationsTab]},t},getAdvancedModeSetting(){return this.userModeSettingsRepository.search(this.userModeSettingsCriteria).then(async t=>{if(!t.total)return;const e=t.first(),r=this.getAdvancedModeDefaultSetting().value.settings;e.value.settings=r.reduce((i,s)=>{const o=e.value.settings.find(d=>d.key===s.key);return i.push(o||s),i},[]),Shopware.Store.get("swProductDetail").advancedModeSetting=e,Shopware.Store.get("swProductDetail").modeSettings=this.changeModeSettings(),await this.$nextTick()})},saveAdvancedMode(){Shopware.Store.get("swProductDetail").setLoading(["advancedMode",!0]),this.userModeSettingsRepository.save(this.advancedModeSetting).then(()=>{this.getAdvancedModeSetting().then(()=>{Shopware.Store.get("swProductDetail").setLoading(["advancedMode",!1])})}).catch(()=>{this.createNotificationError({message:this.$tc("global.notification.unspecifiedSaveErrorMessage")})})},onChangeSetting(){Shopware.Store.get("swProductDetail").advancedModeSetting=this.advancedModeSetting,this.saveAdvancedMode()},changeModeSettings(){const t=this.advancedModeSetting.value.settings.filter(e=>e.enabled);return t.length?t.map(e=>e.key):[]},onChangeSettingItem(){Shopware.Store.get("swProductDetail").modeSettings=this.changeModeSettings(),this.saveAdvancedMode()},loadState(){return Shopware.Store.get("swProductDetail").localMode=!1,Shopware.Store.get("shopwareApps").selectedIds=[this.productId],this.loadAll()},loadAll(){return Promise.all([this.loadProduct(),this.loadCurrencies(),this.loadTaxes(),this.loadAttributeSet()])},createState(){return Shopware.Store.get("swProductDetail").localMode=!0,Shopware.Store.get("shopwareApps").selectedIds=[],Shopware.Store.get("swProductDetail").setLoading(["product",!0]),Shopware.Store.get("swProductDetail").creationStates=this.creationStates,Shopware.Store.get("swProductDetail").product=this.productRepository.create(),this.product.active=!0,this.product.taxId=null,this.product.metaTitle="",this.product.additionalText="",this.product.variantListingConfig={},this.creationStates&&this.adjustProductAccordingToType(),Promise.all([this.loadCurrencies(),this.loadTaxes(),this.loadAttributeSet(),this.loadDefaultFeatureSet()]).then(()=>{var t,e;this.product.price=[{currencyId:this.defaultCurrency.id,net:null,linked:!0,gross:null}],this.product.purchasePrices=this.getDefaultPurchasePrices(),this.product.isNew&&(this.getDefaultTaxRate().then(r=>{this.product.taxId=r}),this.getDefaultSalesChannels().then(r=>{n.isEmpty(r)||(this.product.active=r.defaultActive,!(!r.defaultSalesChannelIds||r.defaultSalesChannelIds.length<=0)&&this.fetchSalesChannelByIds(r.defaultSalesChannelIds).then(i=>{i.length&&i.forEach(s=>{const o=this.createProductVisibilityEntity(r.defaultVisibilities,s);this.product.visibilities.push(o)})}))})),(t=this.getDefaultFeatureSet)!=null&&t.length&&(this.product.featureSetId=(e=this.getDefaultFeatureSet)==null?void 0:e[0].id),Shopware.Store.get("swProductDetail").setLoading(["product",!1])})},adjustProductAccordingToType(){this.creationStates.includes("is-download")&&(this.product.maxPurchase=1)},loadProduct(){return Shopware.Store.get("swProductDetail").setLoading(["product",!0]),this.productRepository.get(this.productId||this.product.id,this.productApiContext,this.productCriteria).then(async t=>{var e,r,i;if(!((e=t.purchasePrices)!=null&&e.length)>0&&!t.parentId&&((r=this.defaultCurrency)!=null&&r.id||await this.loadCurrencies(),t.purchasePrices=this.getDefaultPurchasePrices()),((i=t.propertyIds)==null?void 0:i.length)>0){const s=new a(1,null);s.addSorting(a.sort("name","ASC",!0)),s.setIds(t.propertyIds);const o=await this.propertyRepository.search(s);o.source=t.properties.source,t._origin.properties=c(o),t.properties=o}Shopware.Store.get("swProductDetail").product=t,this.product.parentId?this.loadParentProduct():Shopware.Store.get("swProductDetail").parentProduct={},Shopware.Store.get("swProductDetail").setLoading(["product",!1])})},getDefaultPurchasePrices(){return[{currencyId:this.defaultCurrency.id,net:0,linked:!0,gross:0}]},loadParentProduct(){return Shopware.Store.get("swProductDetail").setLoading(["parentProduct",!0]),this.productRepository.get(this.product.parentId,Shopware.Context.api,this.productCriteria).then(async t=>{var e;if(((e=t.propertyIds)==null?void 0:e.length)>0){const r=new a(1,null);r.addSorting(a.sort("name","ASC",!0)),r.setIds(t.propertyIds);const i=await this.propertyRepository.search(r);i.source=t.properties.source,t._origin.properties=c(i),t.properties=i}Shopware.Store.get("swProductDetail").parentProduct=t}).then(()=>{Shopware.Store.get("swProductDetail").setLoading(["parentProduct",!1])})},loadCurrencies(){return Shopware.Store.get("swProductDetail").setLoading(["currencies",!0]),this.currencyRepository.search(new a(1,500)).then(t=>{Shopware.Store.get("swProductDetail").currencies=t}).finally(()=>{Shopware.Store.get("swProductDetail").setLoading(["currencies",!1])})},loadTaxes(){return Shopware.Store.get("swProductDetail").setLoading(["taxes",!0]),this.taxRepository.search(this.taxCriteria).then(t=>{Shopware.Store.get("swProductDetail").setTaxes(t)}).finally(()=>{Shopware.Store.get("swProductDetail").setLoading(["taxes",!1])})},getDefaultTaxRate(){return this.systemConfigApiService.getValues("core.tax").then(t=>t["core.tax.defaultTaxRate"]??null)},loadAttributeSet(){return Shopware.Store.get("swProductDetail").setLoading(["customFieldSets",!0]),this.customFieldSetRepository.search(this.customFieldSetCriteria).then(t=>{Shopware.Store.get("swProductDetail").customFieldSets=t}).finally(()=>{Shopware.Store.get("swProductDetail").setLoading(["customFieldSets",!1])})},loadDefaultFeatureSet(){return Shopware.Store.get("swProductDetail").setLoading(["defaultFeatureSet",!0]),this.featureSetRepository.search(this.defaultFeatureSetCriteria).then(t=>{Shopware.Store.get("swProductDetail").setDefaultFeatureSet(t)}).finally(()=>{Shopware.Store.get("swProductDetail").setLoading(["defaultFeatureSet",!1])})},getDefaultSalesChannels(){return this.systemConfigApiService.getValues("core.defaultSalesChannel").then(t=>n.isEmpty(t)?{}:{defaultSalesChannelIds:t==null?void 0:t["core.defaultSalesChannel.salesChannel"],defaultVisibilities:t==null?void 0:t["core.defaultSalesChannel.visibility"],defaultActive:!!(t!=null&&t["core.defaultSalesChannel.active"])})},fetchSalesChannelByIds(t){const e=new a(1,25);return e.addFilter(a.equalsAny("id",t)),this.salesChannelRepository.search(e)},createProductVisibilityEntity(t,e){const r=this.productVisibilityRepository.create(y.api);return Object.assign(r,{visibility:t[e.id]||this.defaultSalesChannelVisibility,productId:this.product.id,salesChannelId:e.id,salesChannel:e}),r},abortOnLanguageChange(){return this.productRepository.hasChanges(this.product)},saveOnLanguageChange(){return this.onSave()},onChangeLanguage(t){Shopware.Store.get("context").setApiLanguageId(t),this.loadLanguage(t),this.initState()},saveFinish(){this.isSaveSuccessful=!1,this.productId||this.$router.push({name:"sw.product.detail",params:{id:this.product.id}})},onSave(){if(!this.validateProductPurchase())return this.createNotificationError({message:this.$tc("sw-product.detail.errorMinMaxPurchase")}),new Promise(e=>{e()});this.validateProductPrices(),this.productId||this.productNumberPreview===this.product.productNumber&&this.numberRangeService.reserve("product").then(e=>{this.productNumberPreview="reserved",this.product.productNumber=e.number}),this.isSaveSuccessful=!1;const t=this.getCmsPageOverrides();if(n.isPlainObject(t)&&(this.product.slotConfig=c(t)),!this.entityValidationService.validate(this.product,this.customValidate,this.ignoreFieldsValidation)){const e=this.$tc("global.default.error"),r=this.$tc("global.notification.notificationSaveErrorMessageRequiredFieldsInvalid");return this.createNotificationError({title:e,message:r}),Promise.resolve()}return this.saveProduct().then(this.onSaveFinished)},customValidate(t,e){return this.productStates.includes("is-download")&&(e.downloads===void 0||e.downloads.length<1)&&t.push(f.createRequiredError("/0/downloads")),t},validateProductPrices(){this.product.prices.forEach(t=>{this.validatePrices("listPrice",t.price)}),this.validatePrices("listPrice",this.product.price),this.product.prices.forEach(t=>{this.validatePrices("regulationPrice",t.price)}),this.validatePrices("regulationPrice",this.product.price)},validatePrices(t,e){e&&e.forEach(r=>{if(r[t]){if(!r[t].gross&&!r[t].net){r[t]=null;return}if(!r[t].gross){r[t].gross=0;return}r[t].net||(r[t].net=0)}})},onSaveFinished(t){var e,r,i,s,o,d,u,l;if(t!=="success"&&t!=="empty"){if(((s=(i=(r=(e=t==null?void 0:t.response)==null?void 0:e.data)==null?void 0:r.errors)==null?void 0:i[0])==null?void 0:s.code)==="CONTENT__DUPLICATE_PRODUCT_NUMBER"){const S=this.$tc("global.default.error"),m=this.$t("sw-product.notification.notificationSaveErrorProductNoAlreadyExists",{productNo:t.response.data.errors[0].meta.parameters.number});this.createNotificationError({title:S,message:m});return}const h=(l=(u=(d=(o=t==null?void 0:t.response)==null?void 0:o.data)==null?void 0:d.errors)==null?void 0:u[0])==null?void 0:l.detail,g=this.$tc("global.default.error"),w=h??this.$tc("global.notification.notificationSaveErrorMessageRequiredFieldsInvalid");this.createNotificationError({title:g,message:w});return}if(this.updateSeoPromises.length===0){this.isSaveSuccessful=!0;return}t==="empty"&&(t="success"),Shopware.Store.get("swProductDetail").setLoading(["product",!0]),Promise.all(this.updateSeoPromises).then(()=>{Shopware.Utils.EventBus.emit("sw-product-detail-save-finish")}).then(()=>{switch(t){case"empty":{this.isSaveSuccessful=!0,Shopware.Store.get("error").resetApiErrors();break}case"success":{this.isSaveSuccessful=!0;break}}}).catch(()=>Promise.resolve()).finally(()=>{Shopware.Store.get("swProductDetail").setLoading(["product",!1]),this.loadProduct()})},onCancel(){this.$router.push({name:"sw.product.index"})},saveProduct(){if(Shopware.Store.get("swProductDetail").setLoading(["product",!0]),this.updateSeoPromises=[],Shopware.Store.list().includes("swSeoUrl")){const t=Shopware.Store.get("swSeoUrl").newOrModifiedUrls,e=Shopware.Store.get("swSeoUrl").defaultSeoUrl;t&&t.forEach(r=>{r.seoPathInfo?r.isModified=!0:(r.seoPathInfo=e.seoPathInfo,r.isModified=!1),this.updateSeoPromises.push(this.seoUrlService.updateCanonicalUrl(r,r.languageId))})}return this.product.media&&this.product.media.forEach((t,e)=>{t.position=e}),new Promise(t=>{if(!this.productRepository.hasChanges(this.product)){Shopware.Store.get("swProductDetail").setLoading(["product",!1]),t("empty"),Shopware.Store.get("swProductDetail").setLoading(["product",!1]);return}this.syncRepository.save(this.product,this.productApiContext).then(()=>{this.savePreferenceUnits().then(()=>{this.previousLengthUnit=this.lengthUnit,this.previousWeightUnit=this.weightUnit}).catch(e=>{t(e)}),this.loadAll().then(()=>{Shopware.Store.get("swProductDetail").setLoading(["product",!1]),t("success")})}).catch(e=>{Shopware.Store.get("swProductDetail").setLoading(["product",!1]),t(e)})})},removeMediaItem(t,e){const r=this.product.media.find(i=>i.mediaId===e);this.product.coverId===r.id&&(this.product.coverId=null),this.product.media.remove(e)},onCoverChange(t){if(!t||t.length<0)return;const e=this.product.media.find(r=>r.mediaId===t);e&&(this.product.coverId=e.id)},getInheritTitle(){if(this.product.hasOwnProperty("translated")&&this.product.translated.hasOwnProperty("name")&&this.product.translated.name!==null)return this.product.translated.name;if(this.product.name!==null)return this.product.name;if(this.parentProduct&&this.parentProduct.hasOwnProperty("translated")){const t=this.parentProduct;return t.translated.hasOwnProperty("name")?t.translated.name:t.name}return""},onDuplicate(){this.cloning=!0},onDuplicateFinish(t){this.cloning=!1,this.$router.push({name:"sw.product.detail",params:{id:t.id}})},validateProductPurchase(){return!(this.product.maxPurchase&&this.product.minPurchase>this.product.maxPurchase)},getCmsPageOverrides(){if(this.currentPage===null)return null;this.deleteSpecifcKeys(this.currentPage.sections);const t=new P,{changes:e}=t.generate(this.currentPage),r={};return e===null||n.isArray(e.sections)&&e.sections.forEach(i=>{n.isArray(i.blocks)&&i.blocks.forEach(s=>{n.isArray(s.slots)&&s.slots.forEach(o=>{r[o.id]=o.config})})}),r},deleteSpecifcKeys(t){t&&t.forEach(e=>{e.blocks&&e.blocks.forEach(r=>{r.slots&&r.slots.forEach(i=>{i.config&&Object.values(i.config).forEach(s=>{s.entity&&delete s.entity,s.hasOwnProperty("required")&&delete s.required,s.type&&delete s.type})})})})},async loadLanguage(t){Shopware.Store.get("context").api.language=await this.languageRepository.get(t,{...Shopware.Context.api,inheritance:!0})},async initProductMeasurementUnits(){const t=await this.getPreferredMeasurementUnits(),e=Shopware.Store.get("swProductDetail"),r={length:e.lengthUnit,weight:e.weightUnit},i=t||r;e.setLengthUnit(i.length),e.setWeightUnit(i.weight),this.previousLengthUnit=i.length,this.previousWeightUnit=i.weight},async getPreferredMeasurementUnits(){return(await this.userConfigService.search(["measurement.preferenceUnits"])).data["measurement.preferenceUnits"]},savePreferenceUnits(){return this.measurementUnitsChanged?this.userConfigService.upsert({"measurement.preferenceUnits":{length:this.lengthUnit,weight:this.weightUnit}}):Promise.resolve()}}};export{x as default};
