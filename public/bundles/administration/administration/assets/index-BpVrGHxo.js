const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Cj375JhT.js","assets/store-Dh7w5eyu.js","assets/index-DLkeS9Ry.css","assets/index-DsRX-ATh.js","assets/index-BTLR-D5w.css","assets/index-BL0Mrn0s.js","assets/index-LbBSsmeX.css","assets/index-CdwF5GCD.js","assets/index-IxbZOfGQ.css","assets/index-CgqGRdCf.js","assets/index-0oO4otq6.css","assets/index-Cfv3eA6M.js","assets/index-D8gXp5bh.css","assets/index-DC8SrXAc.js","assets/index-CwCXCFH7.css","assets/index-CV9l5lDq.js","assets/index-Bv2xAWDm.css","assets/index-DMTxTFx7.js","assets/index-BzWzJub7.css","assets/index-UWAUQ0e3.js","assets/index-BfUbnNwM.css","assets/index-_dQu8wS5.js","assets/index-Bsb5u3nn.css","assets/index-qyo2eBkp.js","assets/index-gK9oCgZf.css","assets/index-CFHHvsRM.js","assets/file-reader.utils-X6d2K5Hs.js","assets/index-Fu1HihgL.css"])))=>i.map(i=>d[i]);
import{_ as h}from"./administration-BkFWn-Oy.js";import{R as b}from"./retry.helper-BDu6eVqs.js";const{object:V}=Shopware.Utils,{Criteria:S}=Shopware.Data,v=Object.freeze({OVERWRITE:"overwrite",CLEAR:"clear",ADD:"add",REMOVE:"remove"}),{types:C}=Shopware.Utils,{getObjectDiff:L}=Shopware.Utils.object;class R{constructor(){this.syncService=Shopware.Service("syncService"),this.repositoryFactory=Shopware.Service("repositoryFactory"),this.entityName=null,this.entityIds=[],this.groupedPayload={upsert:{},delete:{}}}async buildBulkSyncPayload(t){const e=Shopware.EntityDefinition.get(this.entityName);if(!e)throw Error(`No schema found for entity ${this.entityName}`);return this.groupedPayload.delete[this.entityName]={},this.groupedPayload.upsert[this.entityName]={},await Promise.all(t.map(async i=>{if(!Object.values(v).includes(i.type))return;const r=e.getField(i.field);if(!r){Shopware.Utils.debug.warn("Entity factory",`Property ${this.entityName}.${i.field} not found`);return}const s=e.isOneToOneAssociation(r);if(e.isToManyAssociation(r)||s)try{await this._handleAssociationChange(r,i,s);return}catch(o){Shopware.Utils.debug.warn(o);return}const n=this._castDefaultValueIfNecessary(i,r.type);this.entityIds.forEach(o=>{var a;(a=this.groupedPayload.upsert[this.entityName])[o]??(a[o]={id:o}),this.groupedPayload.upsert[this.entityName][o][i.field]=n})})),this._transformSyncPayload(this.groupedPayload)}_transformSyncPayload(t){const e={};return Object.keys(t).forEach(i=>{const r=t[i];Object.keys(r).length!==0&&Object.keys(r).forEach(s=>{const n=Object.values(r[s]);if(n.length===0)return;const o=`${i}-${s}`;e[o]??(e[o]={action:i,entity:s,payload:[]}),e[o].payload.push(...n.flat())})}),e}async _handleAssociationChange(t,e,i=!1){const{mapping:r,entity:s,local:n,reference:o,localField:a,referenceField:l}=t,p=!!r;let u;e.referenceEntity=r??s,this.groupedPayload.delete[e.referenceEntity]={},this.groupedPayload.upsert[e.referenceEntity]={};const d=Array.isArray(e.value)?e.value:[e.value];e.value=d.filter(Boolean),p?(e.localKey=n,e.referenceKey=o,u=await this._fetchManyToManyAssociated(t,e)):(e.localKey=a,e.referenceKey=l,u=await this._fetchOneToManyAssociated(t,e));const{referenceEntity:m,localKey:f,referenceKey:c,type:w}=e;if([v.CLEAR,v.REMOVE].includes(w)){this.groupedPayload.delete[m]={...this._transformDeletePayload(u,f,c)};return}w===v.OVERWRITE&&(this.groupedPayload.delete[m]={...this._transformDeletePayload(u,f,c)}),p?this._detectManyToManyChange(e,u):i?this._detectOneToOneChange(e,u):this._detectOneToManyChange(e,u)}_detectOneToManyChange(t,e){const{referenceEntity:i,referenceKey:r,localKey:s,mappingReferenceField:n,value:o,type:a}=t,l=this._getEditableProperties(i);n&&l.push(n),o.forEach(p=>{const u=p;p=V.pick(p,l),this.entityIds.forEach(d=>{var P;const m={...p};m[r]=d;const c=n?`${u[n??s]}.${d}`:d,w=e[c]??[];if(n&&a===v.ADD&&w.length>0)return;let g=null;a===v.OVERWRITE&&w.length===1&&(g={...w[0]},e[c].shift(),delete this.groupedPayload.delete[i][c]);const E=this._getOneToManyChange(m,s,n,g);E===null||Object.keys(E).length===0||((P=this.groupedPayload.upsert[i])[c]??(P[c]=[]),this.groupedPayload.upsert[i][c].push(E))})})}_detectOneToOneChange(t,e){const{referenceEntity:i,referenceKey:r,localKey:s,value:n}=t,o=this._getEditableProperties(i);n.forEach(a=>{a=V.pick(a,o),this.entityIds.forEach(l=>{var c;const p={...a};p[r]=l;const u=l,d=e[u]??[];let m=null;d.length===1&&(m={...d[0]},e[u].shift(),delete this.groupedPayload.delete[i][u]);const f=this._getOneToManyChange(p,s,null,m);f===null||Object.keys(f).length===0||((c=this.groupedPayload.upsert[i])[u]??(c[u]=[]),this.groupedPayload.upsert[i][u].push(f))})})}_getOneToManyChange(t,e,i,r=null){const s={};i&&(s[i]=t[i]),r&&(s[e]=r[e],delete t[e],delete t[i]),Object.keys(t).forEach(o=>{(!r||t[o]!==void 0&&this._isFieldValueChanged(t[o],r[o]))&&(s[o]=t[o])}),r&&delete s[i];const n=Object.keys(s).some(o=>o!==e);return r&&!n?null:s}_detectManyToManyChange(t,e){const{referenceEntity:i,referenceKey:r,localKey:s,value:n}=t;n.forEach(o=>{this.entityIds.forEach(a=>{const l=o.id,p=`${l}.${a}`;if(e[p]){delete this.groupedPayload.delete[i][p];return}this.groupedPayload.upsert[i][p]=[{[r]:l,[s]:a}]})})}_castDefaultValueIfNecessary(t,e){const{value:i,type:r}=t;return r===v.CLEAR?["int","float"].includes(e)?0:null:i===""||typeof i>"u"?null:i}async _fetchOneToManyAssociated(t,e,i=1,r={}){const{entity:s,referenceField:n}=t,o=new S(i,500);if(o.addFilter(S.equalsAny(n,this.entityIds)),e.mappingReferenceField&&e.type===v.REMOVE){const u=e.value.map(d=>d[e.mappingReferenceField]);u&&u.filter(Boolean)&&o.addFilter(S.equalsAny(e.mappingReferenceField,u))}const l=await this.repositoryFactory.create(s).search(o);l.forEach(u=>{let d=u[n];if(e.mappingReferenceField){const{[n]:m,[e.mappingReferenceField]:f}=u;d=`${f}.${m}`}r.hasOwnProperty(d)?r[d].push(u):r[d]=[u]});const p=Object.keys(r).reduce((u,d)=>u+r[d].length,0);return l.total>p?this._fetchOneToManyAssociated(t,e,i+1,r):r}async _fetchManyToManyAssociated(t,e,i=1,r={}){const{referenceField:s,mapping:n,local:o,reference:a}=t,l=e.type===v.REMOVE?e.value.map(f=>f[s]):null,p=new S(i,500);p.addFilter(S.equalsAny(o,this.entityIds)),l&&l.filter(Boolean)&&p.addFilter(S.equalsAny(a,l));const d=await this.repositoryFactory.create(n).searchIds(p);return d.data.forEach(f=>{const{[o]:c,[a]:w}=f,g=`${w}.${c}`;r[g]=[f]}),d.total>Object.keys(r).length?this._fetchManyToManyAssociated(t,e,i+1,r):r}_getEditableProperties(t){const e=Shopware.EntityDefinition.get(t),i=e.filterProperties(r=>e.isScalarField(r)||e.isJsonField(r)||!r.flags||r.flags.write_protected);return Object.keys(i).filter(r=>!["updatedAt","createdAt"].includes(r))}_transformDeletePayload(t,e,i){const r={};return Object.keys(t).forEach(s=>{(t[s]??[]).forEach(o=>{const{id:a,[e]:l,[i]:p}=o;r[s]??(r[s]=[]),a?r[s].push({id:a}):r[s].push({[e]:l,[i]:p})})}),r}_isFieldValueChanged(t,e){return C.isObject(t)&&C.isObject(e)?Object.keys(L(t,e)).length>0:!C.isEqual(t,e)}}const O=Shopware.Utils.types,{Service:F,Application:x}=Shopware,{Criteria:j}=Shopware.Data,{cloneDeep:$}=Shopware.Utils.object;class B extends R{constructor(){super(),this.name="bulkEditProductHandler",this.calculatePriceService=x.getContainer("factory").apiService.getByName("calculate-price"),this.entityName="product",this.entityIds=[],this.products={}}async bulkEdit(t,e,i){var l,p,u;this.entityIds=t;const r=(l=e.find(d=>d.field==="taxId"))==null?void 0:l.value,s=(p=e.find(d=>d.field==="price"))==null?void 0:p.value,n=(u=e.find(d=>d.field==="purchasePrices"))==null?void 0:u.value;let o=[];(r||s||n)&&await this.getProducts(),this.shouldRecalculateTax(r,s,n)&&(o=await this.recalculatePrices(r,s,n),e=e.filter(d=>d.field!=="taxId")),(s||n)&&(o=this.updatePriceDirectly(s,n,o),e=e.filter(d=>d.field!=="price"&&d.field!=="purchasePrices"));const a=await this.buildBulkSyncPayload(e);return o.length&&(!O.isEmpty(a)&&"upsert-product"in a?a["upsert-product"].payload=this.mapProductPricesToSyncPayload(a["upsert-product"].payload,o):a["upsert-product"]={action:"upsert",entity:"product",payload:o}),O.isEmpty(a)?Promise.resolve({data:[]}):b.retry(()=>this.syncService.sync(a,{},{"single-operation":1,"sw-language-id":Shopware.Context.api.languageId,...i}))}shouldRecalculateTax(t,e,i){return t&&this.isNullPrice(e,i)}isNullPrice(t,e){return!t||!t[0].listPrice||!t[0].regulationPrice||!e}mapProductPricesToSyncPayload(t,e){const i=[];return t.forEach(r=>{const s=e.find(n=>n.id===r.id);s&&(r={...r,...s},e=e.filter(n=>n.id!==r.id)),i.push(r)}),i.concat(e)}getProducts(){const t=F("repositoryFactory").create("product"),e=new j(1,25);return e.setIds(this.entityIds),t.search(e,Shopware.Context.api).then(i=>{this.products=i})}async recalculatePrices(t,e,i){const r={},s={},n={},o={},a=this.products.filter(c=>c.taxId!==t);a.forEach(c=>{var w,g,E,P,k,A,D,M;if(!e){const _=(g=(w=c.price)==null?void 0:w.filter(y=>y.linked))==null?void 0:g.map(y=>this.getRecalculatePrice(y));O.isEmpty(_)||(r[c.id]=_)}if(!e||!e[0].listPrice){const _=(P=(E=c.price)==null?void 0:E.filter(y=>{var T;return(T=y.listPrice)==null?void 0:T.linked}))==null?void 0:P.map(y=>this.getRecalculatePrice(y.listPrice));O.isEmpty(_)||(s[c.id]=_)}if(!e||!e[0].regulationPrice){const _=(A=(k=c.price)==null?void 0:k.filter(y=>{var T;return(T=y.regulationPrice)==null?void 0:T.linked}))==null?void 0:A.map(y=>this.getRecalculatePrice(y.regulationPrice));O.isEmpty(_)||(n[c.id]=_)}if(!i){const _=(M=(D=c.purchasePrices)==null?void 0:D.filter(y=>y.linked))==null?void 0:M.map(y=>this.getRecalculatePrice(y));O.isEmpty(_)||(o[c.id]=_)}});const l=await Promise.all([this.calculatePrices(t,r),this.calculatePrices(t,s),this.calculatePrices(t,n),this.calculatePrices(t,o)]),p=l[0],u=l[1],d=l[2],m=l[3],f=[];return a.forEach(c=>{const w=p[c.id]??[],g=u[c.id]??[],E=d[c.id]??[],P=m[c.id]??[],k={id:c.id,taxId:t};c.price&&(k.price=this.getCalculatedPrices(c.price,w,g,E)),c.purchasePrices&&(k.purchasePrices=this.getCalculatedPrices(c.purchasePrices,P)),f.push(k)}),f}getRecalculatePrice(t){return{price:t.gross,currencyId:t.currencyId}}async calculatePrices(t,e){return e===null||Object.keys(e).length===0?{}:this.calculatePriceService.calculatePrices(t,e)}getCalculatedPrices(t,e,i=[],r=[]){const s=[];return t.forEach(n=>{const{currencyId:o,listPrice:a,regulationPrice:l}=n;if(n.linked&&e[o]&&(n.net=n.gross-this.getTax(e[o].calculatedTaxes)),a!=null&&a.linked&&i[o]&&(n.listPrice.net=a.gross-this.getTax(i[o].calculatedTaxes)),l!=null&&l.linked&&r[o]){const p=r[o].calculatedTaxes;n.regulationPrice.net=l.gross-this.getTax(p)}s.push(n)}),s}getTax(t){let e=0;return t.forEach(i=>{e+=i.tax}),e}updatePriceDirectly(t,e,i){const r=[];return this.products.forEach(s=>{const n=i.find(a=>a.id===s.id),o=n??{id:s.id};if(t){const a=(n==null?void 0:n.price)??s.price;o.price=this.updatePrice(t[0],a)}e&&(o.purchasePrices=this.updatePrice(e[0],s.purchasePrices)),n&&(i=i.filter(a=>a.id!==s.id)),r.push(o)}),r.concat(i)}updatePrice(t,e){const i=t.currencyId;let r=[];const s=(e==null?void 0:e.find(o=>o.currencyId===i))??null,n=this.getPrice(t,s);return e&&(r=e.filter(o=>o.currencyId!==i)),r.push(n),r}getPrice(t,e){const i=e==null?void 0:e.listPrice,r=e==null?void 0:e.regulationPrice;let s=$(t);return s=this.formatPrice(s,e),s.listPrice?s.listPrice=this.formatPrice(s.listPrice,i):i&&(s.listPrice=i),s.regulationPrice?s.regulationPrice=this.formatPrice(s.regulationPrice,r):r&&(s.regulationPrice=r),s}formatPrice(t,e){return t.gross===null&&(t.linked=!1,t.gross=(e==null?void 0:e.gross)??0),t.net===null&&(t.linked=!1,t.net=(e==null?void 0:e.net)??0),t}}const{Criteria:N}=Shopware.Data,{types:H}=Shopware.Utils;class K extends R{constructor(){super(),this.name="BulkEditOrderHandler",this.entityIds=[],this.orderStateMachineService=Shopware.Service("orderStateMachineService"),this.orderRepository=Shopware.Service("repositoryFactory").create("order"),this.entityName="order"}async bulkEditStatus(t,e){this.entityIds=t;let i=[];const r=Shopware.Store.get("swBulkEdit").isFlowTriggered,s=await this.orderRepository.search(this.getCriteria());return e.forEach(n=>{n.value&&(i=s.map(o=>{var l,p;const a={documentTypes:n.documentTypes,skipSentDocuments:n.skipSentDocuments,sendMail:n.sendMail};switch(n.field){case"orderTransactions":return this.orderStateMachineService.transitionOrderTransactionState((l=o.transactions.first())==null?void 0:l.id,n.value,a,{},{"sw-skip-trigger-flow":!r});case"orderDeliveries":return this.orderStateMachineService.transitionOrderDeliveryState((p=o.deliveries.first())==null?void 0:p.id,n.value,a,{},{"sw-skip-trigger-flow":!r});default:return this.orderStateMachineService.transitionOrderState(o.id,n.value,a,{},{"sw-skip-trigger-flow":!r})}}))}),Promise.all(i)}async bulkEdit(t,e){this.entityIds=t;const i=await this.buildBulkSyncPayload(e);return H.isEmpty(i)?Promise.resolve({data:[]}):b.retry(()=>this.syncService.sync(i,{},{"single-operation":1,"sw-language-id":Shopware.Context.api.languageId}))}getCriteria(){const t=new N(1,25);return t.setIds(this.entityIds),t.getAssociation("deliveries"),t.getAssociation("transactions"),t}}const U=Shopware.Utils.types;class q extends R{constructor(){super(),this.name="bulkEditCustomerHandler",this.entityName="customer",this.entityIds=[],this.customerGroupRegistrationService=Shopware.Service("customerGroupRegistrationService"),this.customerRepository=Shopware.Service("repositoryFactory").create("customer")}async bulkEdit(t,e){this.entityIds=t;const i=await this.buildBulkSyncPayload(e);return U.isEmpty(i)?Promise.resolve({success:!0}):b.retry(()=>this.syncService.sync(i,{},{"single-operation":1,"sw-language-id":Shopware.Context.api.languageId}))}async bulkEditRequestedGroup(t,e){const i=[],r=Shopware.Store.get("swBulkEdit").isFlowTriggered;return e.forEach(s=>{if(s.value)switch(s.value){case"decline":i.push(b.retry(()=>{this.customerGroupRegistrationService.decline(t,{},{"sw-skip-trigger-flow":!r},{silentError:!0})}));break;case"accept":i.push(b.retry(()=>{this.customerGroupRegistrationService.accept(t,{},{"sw-skip-trigger-flow":!r},{silentError:!0})}));break;default:throw new Error}}),Promise.all(i)}}class G{constructor(){this.handlers={product:()=>new B,order:()=>new K,customer:()=>new q}}getHandler(t){if(!this.handlers[t])throw Error(`Bulk Edit Handler not found for ${t} module`);return this.handlers[t]()}}Shopware.Service().register("bulkEditApiFactory",()=>new G);Shopware.Component.register("sw-bulk-edit-product",()=>h(()=>import("./index-Cj375JhT.js"),__vite__mapDeps([0,1,2])));Shopware.Component.register("sw-bulk-edit-order",()=>h(()=>import("./index-DsRX-ATh.js"),__vite__mapDeps([3,4])));Shopware.Component.register("sw-bulk-edit-customer",()=>h(()=>import("./index-BL0Mrn0s.js"),__vite__mapDeps([5,6])));Shopware.Component.register("sw-bulk-edit-order-documents",()=>h(()=>import("./index-CdwF5GCD.js"),__vite__mapDeps([7,8])));Shopware.Component.register("sw-bulk-edit-order-documents-generate-invoice",()=>h(()=>import("./index-CgqGRdCf.js"),__vite__mapDeps([9,10])));Shopware.Component.extend("sw-bulk-edit-order-documents-generate-cancellation-invoice","sw-bulk-edit-order-documents-generate-invoice",()=>h(()=>import("./index-GrSJWMEV.js"),[]));Shopware.Component.extend("sw-bulk-edit-order-documents-generate-delivery-note","sw-bulk-edit-order-documents-generate-invoice",()=>h(()=>import("./index-kn1JefIP.js"),[]));Shopware.Component.extend("sw-bulk-edit-order-documents-generate-credit-note","sw-bulk-edit-order-documents-generate-invoice",()=>h(()=>import("./index-BNP5JrU1.js"),[]));Shopware.Component.register("sw-bulk-edit-order-documents-download-documents",()=>h(()=>import("./index-Cfv3eA6M.js"),__vite__mapDeps([11,12])));Shopware.Component.extend("sw-bulk-edit-custom-fields","sw-custom-field-set-renderer",()=>h(()=>import("./index-DC8SrXAc.js"),__vite__mapDeps([13,14])));Shopware.Component.register("sw-bulk-edit-change-type",()=>h(()=>import("./index-CV9l5lDq.js"),__vite__mapDeps([15,16])));Shopware.Component.register("sw-bulk-edit-change-type-field-renderer",()=>h(()=>import("./index-DMTxTFx7.js"),__vite__mapDeps([17,18])));Shopware.Component.extend("sw-bulk-edit-form-field-renderer","sw-form-field-renderer",()=>h(()=>import("./index-D60-eBt6.js"),[]));Shopware.Component.register("sw-bulk-edit-product-visibility",()=>h(()=>import("./index-CuqrdiFa.js"),[]));Shopware.Component.register("sw-bulk-edit-product-media",()=>h(()=>import("./index-CA1-I_h-.js"),[]));Shopware.Component.extend("sw-bulk-edit-product-media-form","sw-product-media-form",()=>h(()=>import("./index-BfKDqITl.js"),[]));Shopware.Component.extend("sw-bulk-edit-product-description","sw-text-editor",()=>h(()=>import("./index-1zuITKmm.js"),[]));Shopware.Component.register("sw-bulk-edit-save-modal",()=>h(()=>import("./index-UWAUQ0e3.js"),__vite__mapDeps([19,20])));Shopware.Component.register("sw-bulk-edit-save-modal-confirm",()=>h(()=>import("./index-_dQu8wS5.js"),__vite__mapDeps([21,22])));Shopware.Component.register("sw-bulk-edit-save-modal-process",()=>h(()=>import("./index-qyo2eBkp.js"),__vite__mapDeps([23,24])));Shopware.Component.register("sw-bulk-edit-save-modal-success",()=>h(()=>import("./index-CFHHvsRM.js"),__vite__mapDeps([25,26,27])));Shopware.Component.register("sw-bulk-edit-save-modal-error",()=>h(()=>import("./index-B1TbXKRj.js"),[]));const{Module:W}=Shopware;W.register("sw-bulk-edit",{type:"core",name:"bulk-edit",title:"sw-bulk-edit.general.mainMenuTitle",description:"sw-bulk-edit.general.descriptionTextModule",version:"1.0.0",targetVersion:"1.0.0",routes:{product:{component:"sw-bulk-edit-product",path:"product/:parentId/:includesDigital",meta:{parentPath:"sw.product.index"},children:{save:{component:"sw-bulk-edit-save-modal",path:"save",redirect:{name:"sw.bulk.edit.product.save.confirm"},children:{confirm:{component:"sw-bulk-edit-save-modal-confirm",path:"confirm"},process:{component:"sw-bulk-edit-save-modal-process",path:"process"},success:{component:"sw-bulk-edit-save-modal-success",path:"success"},error:{component:"sw-bulk-edit-save-modal-error",path:"error"}}}}},order:{component:"sw-bulk-edit-order",path:"order/:excludeDelivery",meta:{parentPath:"sw.order.index"},children:{save:{component:"sw-bulk-edit-save-modal",path:"save",redirect:{name:"sw.bulk.edit.order.save.confirm"},children:{confirm:{component:"sw-bulk-edit-save-modal-confirm",path:"confirm"},process:{component:"sw-bulk-edit-save-modal-process",path:"process"},success:{component:"sw-bulk-edit-save-modal-success",path:"success"},error:{component:"sw-bulk-edit-save-modal-error",path:"error"}}}}},customer:{component:"sw-bulk-edit-customer",path:"customer",meta:{parentPath:"sw.customer.index"},children:{save:{component:"sw-bulk-edit-save-modal",path:"save",redirect:{name:"sw.bulk.edit.customer.save.confirm"},children:{confirm:{component:"sw-bulk-edit-save-modal-confirm",path:"confirm"},process:{component:"sw-bulk-edit-save-modal-process",path:"process"},success:{component:"sw-bulk-edit-save-modal-success",path:"success"},error:{component:"sw-bulk-edit-save-modal-error",path:"error"}}}}}}});
