import{D as o,a as i,P as d}from"./promotion.helper-Dhj15HBS.js";import"./channel-D6fkBpuJ.js";const u=`{% block sw_promotion_discount_component %} <mt-card class="sw-promotion-discount-component" position-identifier="sw-promotion-discount-component" :title="$tc('sw-promotion.detail.main.discounts.card')" > <template #headerRight> <sw-context-button class="sw-promotion-discount-component__context-button"> {% block sw_promotion_detail_discounts_item_context_button_delete %} <sw-context-menu-item v-tooltip="{ message: $tc('sw-privileges.tooltip.warning'), disabled: acl.can('promotion.editor'), showOnDisabledElements: true }" variant="danger" class="sw-promotion-context-item__delete-action" :disabled="isEditingDisabled" @click="onShowDeleteModal" > {{ $tc('sw-promotion.detail.main.discounts.buttonDeleteDiscount') }} </sw-context-menu-item> {% endblock %} </sw-context-button> </template> <sw-container columns="1fr 1fr" gap="0px 30px" > {% block sw_promotion_discount_component_scope %} <mt-select ref="selectFieldScope" v-model="discount.scope" required validation="required" :label="$tc('sw-promotion.detail.main.discounts.labelScope')" :disabled="isEditingDisabled" :is-loading="isLoading" :options="fieldScopeOptions" @update:model-value="onDiscountScopeChanged" /> {% endblock %} {% block sw_promotion_discount_condition_consider_product_rules_field %} <template v-if="displayAdvancedRuleOption"> <mt-switch v-model="discount.considerAdvancedRules" bordered :label="$tc('sw-promotion.detail.main.discounts.flagProductScopeLabel')" :disabled="isEditingDisabled" /> </template> {% endblock %} </sw-container> {% block sw_promotion_discount_condition_rules_form %} <template v-if="!shippingScope && discount.considerAdvancedRules === true"> <template v-if="!isSetGroup"> <sw-select-rule-create v-model:rules="discount.discountRules" class="sw-promotion-discount-component__select-discount-rules" :local-mode="discount.isNew()" :rule-filter="ruleFilter" :label="$tc('sw-promotion.detail.main.discounts.labelRules')" :placeholder="$tc('sw-promotion.detail.main.discounts.placeholder')" :disabled="isEditingDisabled" :restricted-rules="restrictedRules" :restriction-snippet="promotionDiscountSnippet" rule-aware-group-key="promotionDiscounts" /> </template> <sw-container columns="1fr 1fr" gap="0px 30px" > {% block sw_promotion_cart_condition_setgroup_filter_apply_field %} <mt-select v-if="!isSet" v-model="discount.applierKey" :label="$tc('sw-promotion.detail.main.discounts.labelApplyCount')" :disabled="isEditingDisabled" :options="applyCountOptions" /> {% endblock %} {% block sw_promotion_cart_condition_setgroup_filter_usage_field %} <mt-select v-if="isMaxUsageVisible" v-model="discount.usageKey" :label="$tc('sw-promotion.detail.main.discounts.labelMaxCount')" :disabled="isEditingDisabled" :options="maxCountOptions" /> {% endblock %} </sw-container> <template v-if="discount.applierKey!=='ALL'"> <sw-container columns="1fr 1fr" gap="0px 30px" > {% block sw_promotion_cart_condition_setgroup_filter_sorting_field %} <mt-select v-model="discount.sorterKey" :label="$tc('sw-promotion.detail.main.discounts.labelSorting')" :disabled="isEditingDisabled" :options="sorterOptions" /> {% endblock %} {% block sw_promotion_cart_condition_setgroup_filter_picker_field %} <mt-select v-if="isPickingModeVisible" v-model="discount.pickerKey" :label="$tc('sw-promotion.detail.main.discounts.labelPicking')" :disabled="isEditingDisabled" :options="pickerOptions" /> {% endblock %} </sw-container> </template> </template> {% endblock %} <sw-container columns="1fr 1fr" gap="0px 30px" > {% block sw_promotion_discount_component_type %} <mt-select v-model="discount.type" class="sw-promotion-discount-component__type-select" :label="$tc('sw-promotion.detail.main.discounts.labelType')" :disabled="isEditingDisabled" :options="discountTypeOptions" @update:model-value="onDiscountTypeChanged" /> {% endblock %} {% block sw_promotion_discount_component_value %} <mt-number-field class="sw-promotion-discount-component__discount-value" validation="required" required :model-value="discount.value" :label="$tc('sw-promotion.detail.main.discounts.labelValue')" :placeholder="$tc('sw-promotion.detail.main.discounts.placeholderValue')" :disabled="isEditingDisabled" @update:model-value="onDiscountValueChanged" > <template #suffix> {{ valueSuffix }} </template> </mt-number-field> {% endblock %} </sw-container> {% block sw_promotion_discount_max_value %} <sw-container v-if="showMaxValueSettings" :key="1" columns="1fr 1fr" justify="end" > {% block sw_promotion_discount_max_value_field %} <mt-number-field v-model="discount.maxValue" :label="$tc('sw-promotion.detail.main.discounts.labelMaxValue')" :help-text="$tc('sw-promotion.detail.main.discounts.helpTextMaxValueAdvancedPrices')" :disabled="isEditingDisabled" @update:model-value="onMaxValueChanged" > <template #suffix> {{ maxValueSuffix }} </template> </mt-number-field> {% endblock %} {% block sw_promotion_discount_max_value_advanced_prices %} <a v-if="showMaxValueAdvancedPrices" class="sw-card__quick-link advanced-prices" role="button" tabindex="0" @click="onClickAdvancedPrices" @keydown.enter="onClickAdvancedPrices" > {{ $tc('sw-promotion.detail.main.discounts.linkAdvancedPrices') }} <mt-icon name="regular-long-arrow-right" size="16px" /> </a> {% endblock %} </sw-container> {% endblock %} {% block sw_promotion_discount_advanced_prices_link %} <sw-container v-if="showAbsoluteAdvancedPricesSettings" :key="2" columns="1fr" justify="end" > <a class="sw-card__quick-link advanced-prices" role="button" tabindex="0" @click="onClickAdvancedPrices" @keydown.enter="onClickAdvancedPrices" > {{ $tc('sw-promotion.detail.main.discounts.linkAdvancedPrices') }} <mt-icon name="regular-long-arrow-right" size="16px" /> </a> </sw-container> {% endblock %} {% block sw_promotion_discount_advanced_prices_modal %} <sw-modal v-if="displayAdvancedPrices" :title="$tc('sw-promotion.detail.main.discounts.pricesModal.advancedPricesHeader')" class="sw-promotion-discount-form__advanced-prices-modal" @modal-close="onCloseAdvancedPricesModal" > <sw-one-to-many-grid :collection="discount.promotionDiscountPrices" :local-mode="true" :columns="currencyPriceColumns" :show-selection="false" :is-loading="isLoading" :show-actions="!isEditingDisabled" > <template #column-currency.translated.name="{ item }"> <p>{{ item.currency.translated.name }}</p> </template> <template #column-price="{ item }"> <mt-number-field v-model="item.price" type="text" size="small" :disabled="isEditingDisabled" > <template #suffix> {{ item.currency.symbol }} </template> </mt-number-field> </template> </sw-one-to-many-grid> <template #modal-footer> <mt-button variant="primary" size="small" @click="onCloseAdvancedPricesModal" > {{ $tc('sw-promotion.detail.main.discounts.pricesModal.closeModal') }} </mt-button> </template> </sw-modal> {% endblock %} {% block sw_promotion_detail_discounts_modal_delete %} <sw-modal v-if="showDeleteModal" variant="small" :title="$tc('sw-promotion.detail.main.discounts.delete.confirmTitle')" class="sw-promotion-detail-discounts-modal" @modal-close="onCloseDeleteModal" > {% block sw_promotion_detail_discounts_modal_delete_text %} <p> {{ $tc('sw-promotion.detail.main.discounts.delete.confirmText') }} </p> {% endblock %} {% block sw_promotion_detail_discounts_modal_delete_footer %} <template #modal-footer> {% block sw_promotion_detail_discounts_modal_delete_action_cancel %} <mt-button size="small" variant="secondary" @click="onCloseDeleteModal" > {{ $tc('global.default.cancel') }} </mt-button> {% endblock %} {% block sw_promotion_detail_discounts_modal_delete_action_delete %} <mt-button size="small" variant="critical" class="sw-promotion-discount-delete-button" @click="onConfirmDelete" > {{ $tc('sw-promotion.detail.main.discounts.delete.buttonDelete') }} </mt-button> {% endblock %} </template> {% endblock %} </sw-modal> {% endblock %} </mt-card> {% endblock %}`;class p{getValueSuffix(t,s="?"){return t===o.PERCENTAGE?"%":s}getMinValue(){return 0}getMaxValue(t){return t===o.PERCENTAGE?100:null}getFixedValue(t,s){return s===o.PERCENTAGE&&(t=t>100?this.getMaxValue(s):t),t<=this.getMinValue()&&(t=this.getMinValue()),t}}const{Mixin:m}=Shopware,{Criteria:a}=Shopware.Data,c=new p,_={template:u,inject:["repositoryFactory","acl","ruleConditionDataProviderService"],emits:["discount-delete"],mixins:[m.getByName("placeholder")],props:{promotion:{type:Object,required:!0},discount:{type:Object,required:!0}},data(){return{displayAdvancedPrices:!1,currencies:[],defaultCurrency:null,isLoading:!1,showRuleModal:!1,showDeleteModal:!1,currencySymbol:null,allowProductRules:!1,cartScope:this.discount.scope===i.CART,shippingScope:this.discount.scope===i.DELIVERY,considerAdvancedRules:this.discount.considerAdvancedRules,availableSetGroups:[],syncService:null,httpClient:null,sorterKeys:[],pickerKeys:[],restrictedRules:[]}},computed:{advancedPricesRepo(){return this.repositoryFactory.create("promotion_discount_prices")},repositoryGroups(){return this.repositoryFactory.create("promotion_setgroup")},currencyRepository(){return this.repositoryFactory.create("currency")},ruleFilter(){const e=new a(1,25);return e.addAssociation("conditions"),e.addSorting(a.sort("name","ASC",!1)),e},currencyPriceColumns(){return[{property:"currency.translated.name",label:this.$tc("sw-promotion.detail.main.discounts.pricesModal.labelCurrency")},{property:"price",dataIndex:"price",label:this.$tc("sw-promotion.detail.main.discounts.pricesModal.labelPrice")}]},scopes(){const e=[{key:i.CART,name:this.$tc("sw-promotion.detail.main.discounts.valueScopeCart")},{key:i.DELIVERY,name:this.$tc("sw-promotion.detail.main.discounts.valueScopeDelivery")},{key:i.SET,name:this.$tc("sw-promotion.detail.main.discounts.valueScopeSet")}];let t=1;return this.availableSetGroups.forEach(()=>{const s=`${i.SETGROUP}-${t}`,n=`${this.$tc("sw-promotion.detail.main.discounts.valueScopeSetGroup")}-${t}`;e.push({key:s,name:n}),t+=1}),e},types(){const e=[{key:o.ABSOLUTE,name:this.$tc("sw-promotion.detail.main.discounts.valueTypeAbsolute")},{key:o.PERCENTAGE,name:this.$tc("sw-promotion.detail.main.discounts.valueTypePercentage")},{key:o.FIXED_UNIT,name:this.$tc("sw-promotion.detail.main.discounts.valueTypeFixedUnit")}];return this.cartScope||e.push({key:o.FIXED,name:this.$tc("sw-promotion.detail.main.discounts.valueTypeFixed")}),this.cartScope&&this.discount.considerAdvancedRules&&e.push({key:o.FIXED,name:this.$tc("sw-promotion.detail.main.discounts.valueTypeFixed")}),e},valueSuffix(){return c.getValueSuffix(this.discount.type,this.currencySymbol)},maxValueSuffix(){return this.currencySymbol},showMaxValueSettings(){return this.discount.type===o.PERCENTAGE},showAbsoluteAdvancedPricesSettings(){return this.discount.type===o.ABSOLUTE||this.discount.type===o.FIXED||this.discount.type===o.FIXED_UNIT},showMaxValueAdvancedPrices(){return this.discount.type===o.PERCENTAGE&&this.discount.maxValue!==null&&this.discount.maxValue!==void 0},maxValueAdvancedPricesTooltip(){return this.discount.type===o.PERCENTAGE&&this.discount.maxValue!==null&&this.discount.promotionDiscountPrices.length>0?this.$tc("sw-promotion.detail.main.discounts.helpTextMaxValueAdvancedPrices"):""},isEditingDisabled(){return this.acl.can("promotion.editor")?!d.isEditingAllowed(this.promotion):!0},displayAdvancedRuleOption(){return this.discount.scope!==i.DELIVERY},graduationSorters(){const e=[];return this.sorterKeys.forEach(t=>{e.push({key:t,name:this.$tc(`sw-promotion-v2.detail.conditions.filter.sorter.${t}`)})}),e},graduationPickers(){const e=[];return this.pickerKeys.forEach(t=>{e.push({key:t,name:this.$tc(`sw-promotion-v2.detail.conditions.filter.picker.${t}`)})}),e},isSetGroup(){return this.discount.scope.split("-")[0]===i.SETGROUP},isSet(){return this.discount.scope===i.SET},graduationAppliers(){const e=[{key:"ALL",name:this.$tc("sw-promotion-v2.detail.conditions.filter.applier.ALL")}];let t=10;const s=this.discount.scope.split("-");if(s[0]===i.SETGROUP){let l=0;this.availableSetGroups.forEach(r=>{l+=1,l===parseInt(s[1],10)&&r.value<t&&r.packagerKey==="COUNT"&&(t=r.value)})}let n;for(n=1;n<=t;n+=1)e.push({key:n.toString(),name:this.$tc("sw-promotion-v2.detail.conditions.filter.applier.SELECT",{count:n},0)});return e},graduationCounts(){const e=[{key:"ALL",name:this.$tc("sw-promotion-v2.detail.conditions.filter.counter.ALL")}];let t;for(t=1;t<10;t+=1)e.push({key:t.toString(),name:this.$tc("sw-promotion-v2.detail.conditions.filter.counter.SELECT",{count:t},0)});return e},isPickingModeVisible(){var e;return!!((e=this.discount.scope)!=null&&e.startsWith(i.SETGROUP)||this.discount.scope===i.SET)},isMaxUsageVisible(){return this.discount.scope!==i.CART},promotionDiscountSnippet(){return this.$tc(this.ruleConditionDataProviderService.getAwarenessConfigurationByAssignmentName("promotionDiscounts").snippet,2)},fieldScopeOptions(){return this.scopes.map((e,t)=>({id:t,value:e.key,label:e.name}))},applyCountOptions(){return this.graduationAppliers.map((e,t)=>({id:t,value:e.key,label:e.name}))},maxCountOptions(){return this.graduationCounts.map((e,t)=>({id:t,value:e.key,label:e.name}))},sorterOptions(){return this.graduationSorters.map((e,t)=>({id:t,value:e.key,label:e.name}))},pickerOptions(){return this.graduationPickers.map((e,t)=>({id:t,value:e.key,label:e.name}))},discountTypeOptions(){return this.types.map((e,t)=>({id:t,value:e.key,label:e.name}))}},created(){this.createdComponent()},methods:{createdComponent(){this.syncService=Shopware.Service("syncService"),this.httpClient=this.syncService.httpClient,this.currencyRepository.search(new a(1,25)).then(e=>{this.currencies=e,this.defaultCurrency=this.currencies.find(t=>t.isSystemDefault),this.currencySymbol=this.defaultCurrency.symbol}),this.isLoading=!0,this.loadSetGroups().then(()=>{this.isLoading=!1}),this.loadSorters().then(e=>{this.sorterKeys=e}),this.loadPickers().then(e=>{this.pickerKeys=e}),this.loadRestrictedRules()},onDiscountScopeChanged(e){this.cartScope=e===i.CART,this.shippingScope=e===i.DELIVERY,e===i.DELIVERY?this.discount.considerAdvancedRules=!1:this.discount.considerAdvancedRules=this.considerAdvancedRules,this.discount.pickerKey="",this.discount.usageKey="ALL",this.isPickingModeVisible&&(this.discount.pickerKey=this.pickerKeys[0])},onDiscountTypeChanged(){this.discount.value=c.getFixedValue(this.discount.value,this.discount.type)},onDiscountValueChanged(e){this.discount.value=c.getFixedValue(e,this.discount.type),this.recalculatePrices()},onMaxValueChanged(e){e===0?(this.discount.maxValue=null,this.clearAdvancedPrices()):this.recalculatePrices()},onClickAdvancedPrices(){this.currencies.forEach(e=>{if(!this.isMemberOfCollection(e)){const t=this.advancedPricesRepo.create(Shopware.Context.api);t.discountId=this.discount.id,t.price=this.calculatePrice(e),t.currencyId=e.id,t.currency=e,this.discount.promotionDiscountPrices.add(t)}}),this.displayAdvancedPrices=!0},recalculatePrices(){this.discount.promotionDiscountPrices.forEach(e=>{const t=this.currencies.get(e.currencyId);t&&(e.price=this.calculatePrice(t))})},calculatePrice(e){const t=this.showMaxValueAdvancedPrices?this.discount.maxValue:this.discount.value;return!t||t<c.getMinValue()?c.getMinValue():t*e.factor},clearAdvancedPrices(){const e=this.discount.promotionDiscountPrices.getIds();let t;for(t=0;t<e.length;t+=1)this.discount.promotionDiscountPrices.remove(e[t])},isMemberOfCollection(e){let t=!1;const s=e.id;return this.discount.promotionDiscountPrices.forEach(n=>{n.currencyId===s&&(t=!0,n.currency=e)}),t},onCloseAdvancedPricesModal(){this.discount.type===o.PERCENTAGE&&this.discount.maxValue===null?this.clearAdvancedPrices():this.discount.promotionDiscountPrices.forEach(e=>{e.price=c.getFixedValue(e.price,o.ABSOLUTE)}),this.displayAdvancedPrices=!1},onShowDeleteModal(){this.showDeleteModal=!0},onCloseDeleteModal(){this.showDeleteModal=!1},onConfirmDelete(){this.onCloseDeleteModal(),this.$nextTick(()=>{this.$emit("discount-delete",this.discount)})},async loadSetGroups(){const e=new a(1,25);return e.addFilter(a.equals("promotionId",this.promotion.id)),await this.repositoryGroups.search(e).then(t=>{this.availableSetGroups=t}),!0},async loadSorters(){return this.httpClient.get("/_action/promotion/setgroup/sorter",{headers:this.syncService.getBasicHeaders()}).then(e=>e.data)},async loadPickers(){return this.httpClient.get("/_action/promotion/discount/picker",{headers:this.syncService.getBasicHeaders()}).then(e=>e.data)},loadRestrictedRules(){this.ruleConditionDataProviderService.getRestrictedRules("promotionSetGroups").then(e=>{this.restrictedRules=e})}}};export{_ as default};
