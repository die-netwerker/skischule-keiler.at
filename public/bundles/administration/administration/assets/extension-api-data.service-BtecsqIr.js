import{u as P}from"./util.service-Y0r3dATM.js";import{E as x,aQ as A,aR as C,aS as R,aT as T,M as p,aU as I,aV as b,b as M,C as W,aW as G}from"./channel-D6fkBpuJ.js";class j{constructor({code:t,meta:r={},status:n="",detail:_=""}={}){if(this.selfLink=void 0,typeof t!="string"||t==="")throw new Error("[ShopwareError] can not identify error by code");this._id=P.createId(),this._code=t,this._parameters=r.parameters,this._status=n,this._detail=_}get id(){return this._id}get code(){return this._code}set code(t){this._code=t}get parameters(){return this._parameters}set parameters(t){this._parameters=t}get status(){return this._status}set status(t){this._status=t}get detail(){return this._detail}set detail(t){this._trace=t}}A((e,t,r)=>{Shopware.Application.view.setReactive(e,t,r)});function L(e){return(t,r,n)=>(e==="datasetSubscribe"&&R("datasetSubscribeRegistration",{id:t,selectors:n==null?void 0:n.selectors}),T(e,a=>{var o;if((a==null?void 0:a.id)!==t||a.selectors&&a.selectors.length>0&&((o=n==null?void 0:n.selectors)===null||o===void 0?void 0:o.sort().join(","))!==a.selectors.sort().join(","))return;(a==null?void 0:a.data)instanceof p&&console.error(a.data);const u=r(a);u&&u.catch(()=>{})}))}const E=C,N=L("datasetUpdate"),V=I("datasetGet");var k={};let h=[],l=[];function m(e){return b.cloneDeepWith(e,t=>{if(t!=null&&t.__identifier__&&typeof t.__identifier__=="function"&&t.__identifier__()==="EntityCollection")return new M(t.source,t.entity,{},t.criteria===null?t.criteria:W.fromCriteria(t.criteria),m(Array.from(t)),t.total,t.aggregations);if(t!=null&&t.__identifier__&&typeof t.__identifier__=="function"&&t.__identifier__()==="Entity")return new x(t.id,t._entityName,m(t._draft),{originData:m(t._origin),isDirty:t._isDirty,isNew:t._isNew})})}V((e,t)=>{var u;const r=(u=t==null?void 0:t._event_)==null?void 0:u.origin,n=h.find(g=>g.id===e.id);if(!n)return null;if(n.deprecated){const g=Object.values(Shopware.Store.get("extensions").extensionsState).find(i=>i.baseUrl.startsWith(t._event_.origin));if(!g)throw new Error(`Extension with the origin "${t._event_.origin}" not found.`);const S=["CORE",`The extension "${g.name}" uses a deprecated data set "${e.id}". ${n.deprecationMessage}`];k!=="prod"?Shopware.Utils.debug.error(...S):Shopware.Utils.debug.warn(...S)}const _=e.selectors;if(!_)return n.data;const a=m(n.data),o=G(a,_,"datasetGet",r);return o instanceof p&&console.error(o),o});function F(e){if(!e.includes("."))return null;const t=e.split("."),r=t.pop(),n=t.join(".");return r&&r.length&&n&&n.length?{pathToLastSegment:n,lastSegment:r}:null}function q({id:e,path:t,scope:r,deprecated:n,deprecationMessage:_,showDoubleRegistrationError:a=!0}){var g,S;l.includes(e)&&(l=l.filter(i=>i!==e));const o=h.find(i=>i.id===e);if(o&&o.scope!==((g=r==null?void 0:r.$)==null?void 0:g.uid))return a&&console.error(`The dataset id "${e}" you tried to publish is already registered.`),()=>{};if(o&&o.scope===((S=r==null?void 0:r.$)==null?void 0:S.uid))return E({id:e,data:b.get(r,t)}).catch(()=>{}),()=>{};N(e,i=>{var w;if(!i)return;function f(s,c=null){typeof(s==null?void 0:s.getIsDirty)=="function"&&!s.getIsDirty()||Object.keys(s).forEach(d=>{let D;c?D=`${c}.${d}`:D=`${t}.${d}`;const y=F(D);if(y!==null){if(Shopware.Utils.hasOwnProperty(s[d],"getDraft",this)&&typeof s[d].getDraft=="function"){f({[d]:Shopware.Utils.object.cloneDeep(s[d])},D);return}if(Array.isArray(s[d])){s[d].forEach(($,U)=>{f({[U]:$},D)});return}Shopware.Utils.object.get(r,y.pathToLastSegment)[y.lastSegment]=s[d]}})}if(typeof((w=i.data)==null?void 0:w.getDraft)=="function"){f(i.data);return}if(Array.isArray(i.data))i.data.forEach((s,c)=>{s===null||typeof s!="object"||f({[c]:s})});else if(typeof i.data=="object"){f(i.data);return}if(t.includes(".")){const s=t.split("."),c=s.pop(),d=s.join(".");if(!c)return;Shopware.Utils.object.get(r,d)[c]=i.data;return}r[t]=i.data});const u=r.$watch(t,b.debounce(i=>{var s;if(l.includes(e)){l=l.filter(c=>c!==e),u();return}const f=m(i);E({id:e,data:f}).catch(()=>{});const w=h.find(c=>c.id===e);if(w){w.data=i;return}h.push({id:e,data:f,scope:(s=r==null?void 0:r.$)==null?void 0:s.uid,deprecated:n,deprecationMessage:_})},750),{deep:!0,immediate:!0});return r.dataSetUnwatchers.push(()=>{h=h.filter(i=>i.id!==e),l.push(e),u()}),E({id:e,data:b.get(r,t)}).catch(()=>{}),function(){h=h.filter(f=>f.id!==e),l.push(e),u()}}function z(){return h}export{j as S,m as d,z as g,q as p};
