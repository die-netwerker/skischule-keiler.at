import{a as G}from"./channel-D6fkBpuJ.js";import{R}from"./retry.helper-BDu6eVqs.js";const j=`{% block sw_product_modal_variant_generation %} <sw-modal v-if="!showUploadModal" :title="$tc('sw-product.variations.configuratorModal.title')" class="sw-product-modal-variant-generation" @modal-close="$emit('modal-close')" > {% block sw_product_modal_variant_generation_sidebar %} <div class="sw-product-modal-variant-generation__sidebar"> {% block sw_product_modal_variant_generation_sidebar_tabs %} <sw-tabs is-vertical position-identifier="sw-product-modal-variant-generation" > {% block sw_product_modal_variant_generation_sidebar_tabs_items %} {% block sw_product_modal_variant_generation_sidebar_tabs_item_options %} <sw-tabs-item class="sw-variant-modal__option-selection" :active="activeTab == 'options'" @click="activeTab = 'options'" > {{ $tc('sw-product.variations.configuratorModal.selectOptions') }} </sw-tabs-item> {% endblock %} {% block sw_product_modal_variant_generation_sidebar_tabs_item_prices %} <sw-tabs-item v-show="variantsNumber" class="sw-variant-modal__surcharge-configuration" :active="activeTab == 'prices'" @click="activeTab = 'prices'" > {{ $tc('sw-product.variations.configuratorModal.priceSurcharges') }} </sw-tabs-item> {% endblock %} {% block sw_product_modal_variant_generation_sidebar_tabs_item_restrictions %} <sw-tabs-item v-show="variantsNumber" class="sw-variant-modal__restriction-configuration" :active="activeTab == 'restrictions'" @click="activeTab = 'restrictions'" > {{ $tc('sw-product.variations.configuratorModal.defineRestrictions') }} </sw-tabs-item> {% endblock %} {% endblock %} </sw-tabs> {% endblock %} {% block sw_product_modal_variant_generation_sidebar_descriptions %} {% block sw_product_modal_variant_generation_sidebar_descriptions_options %} <div v-if="activeTab == 'options'"> <p>{{ $tc('sw-product.variations.configuratorModal.selectOptionsExplanation') }}</p> {% block sw_product_modal_variant_generation_sidebar_add_only_selected %} <mt-switch v-model="isAddOnly" :label="$tc('sw-product.variations.configuratorModal.addVariantsOnly')" /> {% endblock %} </div> {% endblock %} {% block sw_product_modal_variant_generation_sidebar_descriptions_restrictions %} <p v-else-if="activeTab == 'restrictions'"> {{ $tc('sw-product.variations.configuratorModal.selectRestrictionsExplanation') }} </p> {% endblock %} {% block sw_product_modal_variant_generation_sidebar_descriptions_prices %} <p v-else-if="activeTab == 'prices'"> {{ $tc('sw-product.variations.configuratorModal.selectPricesExplanation') }} </p> {% endblock %} {% endblock %} </div> {% endblock %} {% block sw_product_modal_variant_generation_main %} <div class="sw-product-modal-variant-generation__main"> {% block sw_product_modal_variant_generation_main_configurator_selection %} <sw-product-variants-configurator-selection v-show="activeTab == 'options'" :product="product" :options="product.configuratorSettings" :overlay="false" :collapsible="false" :is-add-only="isAddOnly" @variations-finish-generate="$emit('variations-finish-generate')" @option-select="calcVariantsNumber()" /> {% endblock %} {% block sw_product_modal_variant_generation_main_configurator_prices %} <sw-product-variants-configurator-prices v-if="activeTab == 'prices'" :product="product" :selected-groups="selectedGroups" /> {% endblock %} {% block sw_product_modal_variant_generation_main_configurator_restrictions %} <sw-product-variants-configurator-restrictions v-if="activeTab == 'restrictions'" :product="product" :selected-groups="selectedGroups" /> {% endblock %} </div> {% endblock %} {% block sw_product_modal_variant_generation_footer %} <template #modal-footer> {% block sw_product_modal_variant_generation_footer_cancel %} <mt-button size="small" variant="secondary" @click="onModalCancel" > {{ $tc('global.default.cancel') }} </mt-button> {% endblock %} {% block sw_product_modal_variant_generation_footer_generate %} <mt-button class="sw-product-variant-generation__next-action" variant="primary" size="small" @click="showNextStep" > {{ $tc('sw-product.variations.nextModalButton') }} </mt-button> {% endblock %} </template> {% endblock %} </sw-modal> <sw-modal v-else :title="$tc('sw-product.variations.configuratorModal.title')" class="sw-product-modal-variant-generation sw-product-modal-variant-generation__upload_files" @modal-close="$emit('modal-close')" > <div class="sw-product-modal-variant-generation__infoBox"> {{ $tc('sw-product.variations.configuratorModal.uploadInfoBoxHeader') }} <div class="sw-product-modal-variant-generation__infoBoxContent"> <span class="sw-product-modal-variant-generation__variant-amount"> {{ $tc('sw-product.variations.configuratorModal.uploadInfoBoxCount', { count: variantGenerationQueue.createQueue.length }, variantGenerationQueue.createQueue.length) }} </span> {{ $tc('sw-product.variations.configuratorModal.uploadInfoBoxCreateLabel', { count: variantGenerationQueue.createQueue.length }, variantGenerationQueue.createQueue.length) }} <span class="sw-product-modal-variant-generation__variant-amount"> {{ $tc('sw-product.variations.configuratorModal.uploadInfoBoxCount', { count: variantGenerationQueue.deleteQueue.length }, variantGenerationQueue.deleteQueue.length) }} </span> {{ $tc('sw-product.variations.configuratorModal.uploadInfoBoxDeleteLabel', { count: variantGenerationQueue.deleteQueue.length }, variantGenerationQueue.deleteQueue.length) }} </div> </div> <template v-if="variantGenerationQueue.createQueue.length > 0"> <div class="sw-product-modal-variant-generation__upload-card"> <div class="sw-product-modal-variant-generation__card-title"> {{ $tc('sw-product.variations.configuratorModal.uploadCardDescription') }} </div> <div class="sw-product-modal-variant-generation__upload-all-container"> <mt-switch :label="$tc('sw-product.variations.configuratorModal.digitalVariantSwitch')" @update:model-value="onChangeAllVariantValues" /> <div class="sw-product-modal-variant-generation__upload-all"> <sw-upload-listener upload-tag="upload_all" auto-upload @media-upload-finish="successfulUpload" /> <sw-media-compact-upload-v2 v-if="productDownloadFolderId" :button-label="$tc('sw-product.variations.configuratorModal.uploadAllButton')" :remove-button-label="$tc('sw-product.variations.configuratorModal.removeAllButton')" upload-tag="upload_all" private-filesystem :source-multiselect="downloadFilesForAllVariants.length > 0 ? downloadFilesForAllVariants : null" allow-multi-select add-files-on-multiselect :target-folder-id="productDownloadFolderId" file-accept="*/*" @delete-item="(file) => removeFileForAllVariants(file)" /> </div> </div> <div class="sw-product-modal-variant-generation__toolbar"> <sw-card-filter :placeholder="$tc('sw-product.variations.configuratorModal.uploadCardSearchPlaceholder')" @sw-card-filter-term-change="onTermChange" /> </div> <sw-data-grid class="sw-product-modal-variant-generation__grid" :data-source="paginatedVariantArray" :show-selection="false" :show-header="false" :show-actions="false" :compact-mode="false" :plain-appearance="true" :columns="[ { property: 'options', label: 'Optionen' }, ]" > <template #column-options="{ item }"> <div> <template v-for="(option, index) in item.options" :key="index" > <span v-if="option.entity" > {{ option.entity.group.translated?.name || option.entity.group.name }}: {{ option.entity.translated?.name || option.entity.name }} <template v-if="index != Object.keys(item.options).length - 1">|</template> </span> </template> </div> <div :key="item.id" class="sw-data-grid__item" > <mt-switch label="Digital" :model-value="item.productStates.includes('is-download')" @update:model-value="(event) => onChangeVariantValue(event, item)" /> <sw-upload-listener :upload-tag="item.productNumber" auto-upload @media-upload-finish="(event) => successfulUpload(event, item)" /> <sw-media-compact-upload-v2 v-if="productDownloadFolderId" :upload-tag="item.productNumber" :disabled="item.productStates.length === 0" private-filesystem allow-multi-select add-files-on-multiselect :source-multiselect="item.downloads.length > 0 ? item.downloads : null" :target-folder-id="productDownloadFolderId" file-accept="*/*" @delete-item="(file) => removeFile(\`\${file.fileName}.\${file.fileExtension}\`, item)" /> </div> </template> <template #pagination> <sw-pagination :page="page" :limit="limit" :total="total" :total-visible="7" @page-change="handlePageChange" /> </template> </sw-data-grid> </div> </template> <template #modal-footer> <mt-button size="small" variant="secondary" @click="showUploadModal = false" > {{ $tc('sw-product.variations.backVariationsButton') }} </mt-button> <mt-button :disabled="isGenerateButtonDisabled" class="sw-product-variant-generation__generate-action" :variant="buttonVariant" :is-loading="isLoading" size="small" @click="generateVariants()" > {{ buttonLabel }} </mt-button> </template> <template #modal-loader> <transition name="generate-variant-progress-bar-transition"> <div v-if="isLoading" class="generate-variant-progress-bar__wrapper" > <mt-progress-bar class="generate-variant-progress-bar" :model-value="actualProgress" :max-value="maxProgress" /> <span class="generate-variant-progress-bar__description"> {{ actualProgress }} {{ $tc('sw-product.variations.progressTypeOf') }} {{ maxProgress }} {{ $tc('sw-product.variations.progressTypeVariation') }} {{ progressMessage }} </span> </div> </transition> </template> </sw-modal> {% endblock %}`;var $={exports:{}},T;function D(){if(T)return $.exports;T=1;var r=typeof Reflect=="object"?Reflect:null,i=r&&typeof r.apply=="function"?r.apply:function(e,o,l){return Function.prototype.apply.call(e,o,l)},n;r&&typeof r.ownKeys=="function"?n=r.ownKeys:Object.getOwnPropertySymbols?n=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:n=function(e){return Object.getOwnPropertyNames(e)};function s(t){console&&console.warn&&console.warn(t)}var u=Number.isNaN||function(e){return e!==e};function a(){a.init.call(this)}$.exports=a,$.exports.once=b,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var f=10;function h(t){if(typeof t!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return f},set:function(t){if(typeof t!="number"||t<0||u(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");f=t}}),a.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||u(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function g(t){return t._maxListeners===void 0?a.defaultMaxListeners:t._maxListeners}a.prototype.getMaxListeners=function(){return g(this)},a.prototype.emit=function(e){for(var o=[],l=1;l<arguments.length;l++)o.push(arguments[l]);var d=e==="error",p=this._events;if(p!==void 0)d=d&&p.error===void 0;else if(!d)return!1;if(d){var c;if(o.length>0&&(c=o[0]),c instanceof Error)throw c;var v=new Error("Unhandled error."+(c?" ("+c.message+")":""));throw v.context=c,v}var L=p[e];if(L===void 0)return!1;if(typeof L=="function")i(L,this,o);else for(var V=L.length,k=E(L,V),l=0;l<V;++l)i(k[l],this,o);return!0};function m(t,e,o,l){var d,p,c;if(h(o),p=t._events,p===void 0?(p=t._events=Object.create(null),t._eventsCount=0):(p.newListener!==void 0&&(t.emit("newListener",e,o.listener?o.listener:o),p=t._events),c=p[e]),c===void 0)c=p[e]=o,++t._eventsCount;else if(typeof c=="function"?c=p[e]=l?[o,c]:[c,o]:l?c.unshift(o):c.push(o),d=g(t),d>0&&c.length>d&&!c.warned){c.warned=!0;var v=new Error("Possible EventEmitter memory leak detected. "+c.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");v.name="MaxListenersExceededWarning",v.emitter=t,v.type=e,v.count=c.length,s(v)}return t}a.prototype.addListener=function(e,o){return m(this,e,o,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,o){return m(this,e,o,!0)};function x(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function w(t,e,o){var l={fired:!1,wrapFn:void 0,target:t,type:e,listener:o},d=x.bind(l);return d.listener=o,l.wrapFn=d,d}a.prototype.once=function(e,o){return h(o),this.on(e,w(this,e,o)),this},a.prototype.prependOnceListener=function(e,o){return h(o),this.prependListener(e,w(this,e,o)),this},a.prototype.removeListener=function(e,o){var l,d,p,c,v;if(h(o),d=this._events,d===void 0)return this;if(l=d[e],l===void 0)return this;if(l===o||l.listener===o)--this._eventsCount===0?this._events=Object.create(null):(delete d[e],d.removeListener&&this.emit("removeListener",e,l.listener||o));else if(typeof l!="function"){for(p=-1,c=l.length-1;c>=0;c--)if(l[c]===o||l[c].listener===o){v=l[c].listener,p=c;break}if(p<0)return this;p===0?l.shift():Q(l,p),l.length===1&&(d[e]=l[0]),d.removeListener!==void 0&&this.emit("removeListener",e,v||o)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(e){var o,l,d;if(l=this._events,l===void 0)return this;if(l.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):l[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete l[e]),this;if(arguments.length===0){var p=Object.keys(l),c;for(d=0;d<p.length;++d)c=p[d],c!=="removeListener"&&this.removeAllListeners(c);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(o=l[e],typeof o=="function")this.removeListener(e,o);else if(o!==void 0)for(d=o.length-1;d>=0;d--)this.removeListener(e,o[d]);return this};function y(t,e,o){var l=t._events;if(l===void 0)return[];var d=l[e];return d===void 0?[]:typeof d=="function"?o?[d.listener||d]:[d]:o?_(d):E(d,d.length)}a.prototype.listeners=function(e){return y(this,e,!0)},a.prototype.rawListeners=function(e){return y(this,e,!1)},a.listenerCount=function(t,e){return typeof t.listenerCount=="function"?t.listenerCount(e):S.call(t,e)},a.prototype.listenerCount=S;function S(t){var e=this._events;if(e!==void 0){var o=e[t];if(typeof o=="function")return 1;if(o!==void 0)return o.length}return 0}a.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]};function E(t,e){for(var o=new Array(e),l=0;l<e;++l)o[l]=t[l];return o}function Q(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}function _(t){for(var e=new Array(t.length),o=0;o<e.length;++o)e[o]=t[o].listener||t[o];return e}function b(t,e){return new Promise(function(o,l){function d(c){t.removeListener(e,p),l(c)}function p(){typeof t.removeListener=="function"&&t.removeListener("error",d),o([].slice.call(arguments))}O(t,e,p,{once:!0}),e!=="error"&&F(t,d,{once:!0})})}function F(t,e,o){typeof t.on=="function"&&O(t,"error",e,o)}function O(t,e,o,l){if(typeof t.on=="function")l.once?t.once(e,o):t.on(e,o);else if(typeof t.addEventListener=="function")t.addEventListener(e,function d(p){l.once&&t.removeEventListener(e,d),o(p)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t)}return $.exports}var U=D();const B=G(U),{deepCopyObject:K}=Shopware.Utils.object,{md5:P}=Shopware.Utils.format;class z extends B{constructor(){super(),this.product=null,this.productIds=[],this.syncService=Shopware.Service("syncService"),this.cacheService=Shopware.Service("cacheApiService"),this.httpClient=this.syncService.httpClient,this.languageId=null}saveVariants(i){return new Promise(n=>{this.emit("progress-max",{type:"delete",progress:i.deleteQueue.length});const s=i.deleteQueue.map(u=>({id:u}));this.processQueue("delete",s,0,10,n)}).then(()=>(this.emit("progress-max",{type:"upsert",progress:i.createQueue.length}),new Promise(n=>{this.processQueue("upsert",i.createQueue,0,10,n)}))).then(()=>{this.indexProducts(this.productIds)})}generateVariants(i,n,s=!1){this.product=n;const u=this.product.configuratorSettings;return(!this.product.variantListingConfig||!this.product.variantListingConfig.displayParent&&!this.product.variantListingConfig.configuratorGroupConfig&&!this.product.variantListingConfig.mainVariantId)&&(this.product.variantListingConfig={},this.product.variantListingConfig.displayParent=!0),new Promise(()=>{const a=this.groupTheOptions(u);if(a.length<=0){this.loadExisting(this.product.id).then(h=>{const g=Object.keys(h).map(m=>m);this.emit("queues",{createQueue:[],deleteQueue:s?[]:g})});return}const f=this.buildCombinations(a);this.loadExisting(this.product.id).then(h=>this.filterVariations(f,h,i,s)).then(h=>{this.emit("queues",h)})})}filterVariations(i,n,s,u=!1){const a=this.product.configuratorSettings;return new Promise(f=>{const h=[],g={},m={},x={};for(const[_,b]of Object.entries(n)){const F=P(JSON.stringify(b.options.sort()));g[F]=_,x[F]=b.productNumber,m[b.productNumber]=!0}let w=[];u||(w=K(g));const y=i.map(_=>_.sort()),S=a.reduce((_,b)=>(_.push({id:b.option.id,price:b.price}),_),[]);this.emit("progress-max",{type:"calc",progress:y.length});let E=1;y.forEach(_=>{const b=P(JSON.stringify(_));g[b]!==void 0&&delete w[b]}),Object.keys(w).forEach(_=>{delete m[x[_]]}),y.forEach(_=>{const b=P(JSON.stringify(_));if(g[b]!==void 0)return;const O=_.map(l=>({id:l}));let t={};O.map(l=>l.id).forEach(l=>{S.forEach(d=>{d.price&&d.id===l&&d.price.forEach(p=>{const c=p.currencyId;let v;t[c]?v=t[c]:v=this.product.price.find(A=>A.currencyId===p.currencyId);let L=v;if(!v){const A=s.find(C=>C.isSystemDefault),I=this.product.price.find(C=>C.currencyId===A.id),M=s.find(C=>C.id===p.currencyId);L={net:I.net*M.factor,gross:I.gross*M.factor}}const V=L.gross+p.gross,k=L.net+p.net;t[c]={currencyId:p.currencyId,gross:V,linked:p.linked,net:k}})})});const e=this.createNumber(this.product.productNumber,E,m);E=e.increment;const o={parentId:this.product.id,options:O,stock:0,productNumber:e.number};t=Object.values(t),t.length>0&&(o.price=t),h.push(o)}),w=Object.values(w);const Q=this.filterRestrictions(h);f({deleteQueue:w,createQueue:Q})})}createNumber(i,n,s){let u=!0,a=null;for(;u;)a=`${i}.${n}`,u=s.hasOwnProperty(a),n+=1;return{number:a,increment:n}}filterRestrictions(i){const s=(this.product.variantRestrictions||[]).map(u=>u.values.map(a=>a.options));return s.length<=0?i:i.filter(u=>{const a=u.options.map(f=>f.id);return s.reduce((f,h)=>h.reduce((m,x)=>x.find(y=>a.indexOf(y)>=0)?m:!1,!0)?!1:f,!0)})}loadExisting(i){return this.httpClient.get(`/_action/product/${i}/combinations`,{headers:this.syncService.getBasicHeaders()}).then(n=>n.data)}groupTheOptions(i){const n=i.reduce((s,u)=>{const a=u.option.groupId,f=s[a];return f?(f.push(u.option.id),s):(s[a]=[u.option.id],s)},{});return Object.values(n)}buildCombinations(i,n=[],s=null,u=0){const a=[];return s!==null&&n.push(s),u>=i.length?(a.push(n),a):(i[u].forEach(f=>{this.buildCombinations(i,n.slice(),f,u+1).forEach(g=>{a.push(g)})}),a)}processQueue(i,n,s,u,a){const f=n.slice(s,s+u);if(f.length<=0){a();return}this.emit("progress-actual",{type:i,progress:s});const h=[{action:i,entity:"product",payload:f}],g={"single-operation":1};R.retry(()=>this.syncService.sync(h,{"indexing-behavior":"disable-indexing"},g)).then(m=>{var x,w,y;this.productIds.concat(((x=m.data)==null?void 0:x.product)??[]).concat(((y=(w=m.data)==null?void 0:w.deleted)==null?void 0:y.product)??[]),this.processQueue(i,n,s+u,u,a)})}indexProducts(i){i.length<=0||this.cacheService.indexProducts(i)}}const{Criteria:N}=Shopware.Data,{Mixin:H,Context:W}=Shopware,X={template:j,inject:["repositoryFactory","mediaService","swProductDetailLoadAll"],emits:["modal-close","variations-finish-generate"],mixins:[H.getByName("listing")],props:{product:{type:Object,required:!0},groups:{type:Array,required:!0},selectedGroups:{type:Array,required:!0},actualStatus:{type:String,default:"is-physical",required:!1}},data(){return{activeTab:"options",isLoading:!1,actualProgress:0,maxProgress:0,progressType:"",variantsNumber:0,variantsGenerator:null,showUploadModal:!1,variantGenerationQueue:{createQueue:[],deleteQueue:[]},term:"",paginatedVariantArray:[],disableRouteParams:!0,downloadFilesForAllVariants:[],usageOfFiles:{},idToIndex:{},productDownloadFolderId:null,isAddOnly:!1,originalConfiguratorSettings:[]}},computed:{currencies(){return Shopware.Store.get("swProductDetail").currencies},productRepository(){return this.repositoryFactory.create("product")},optionRepository(){return this.repositoryFactory.create("property_group_option")},mediaRepository(){return this.repositoryFactory.create("media")},progressInPercentage(){return this.actualProgress/(this.maxProgress*100)},progressMessage(){return this.progressType==="delete"?this.$tc("sw-product.variations.progressTypeDeleted"):this.progressType==="upsert"?this.$tc("sw-product.variations.progressTypeGenerated"):this.progressType==="calc"?this.$tc("sw-product.variations.progressTypeCalculated"):""},buttonVariant(){return this.variantsNumber<=0?"critical":"primary"},buttonLabel(){return this.variantsNumber<=0?this.$tc("sw-product.variations.deleteVariationsButton"):this.$tc("sw-product.variations.generateVariationsButton")},isGenerateButtonDisabled(){return this.variantGenerationQueue.createQueue.some(r=>{var i;return r.downloads.length===0&&((i=r.productStates)==null?void 0:i.includes("is-download"))})}},watch:{variantGenerationQueue(){this.getList(),this.showUploadModal=!0},isAddOnly(){if(this.isAddOnly){this.emptyConfiguratorSettings();return}this.addOriginalConfiguratorSettings()}},created(){this.createdComponent()},methods:{createdComponent(){this.mediaService.getDefaultFolderId("product_download").then(r=>{this.productDownloadFolderId=r}),this.variantsGenerator=new z,this.term="",this.variantsGenerator.on("queues",r=>{const i=this.product.configuratorSettings.reduce((n,s)=>(n.indexOf(s.option.id)<0&&n.push(s.option.id),n),[]);if(i.length>0){const n=new N(1,500);n.addFilter(N.equalsAny("id",i)),n.addAssociation("group"),this.optionRepository.search(n).then(s=>{r.createQueue.forEach((u,a)=>{u.options.forEach(f=>{f.entity=s.get(f.id)}),u.options.sort((f,h)=>{const g=f.entity.group.name,m=h.entity.group.name;return g.localeCompare(m)}),u.downloads=[],u.productStates=[],u.id=u.productNumber,this.idToIndex[u.id]=a}),this.variantGenerationQueue=r,this.total=r.createQueue.length})}else this.variantGenerationQueue=r,this.total=r.createQueue.length;this.isLoading=!1}),this.variantsGenerator.on("progress-max",r=>{this.maxProgress=r.progress,this.progressType=r.type}),this.variantsGenerator.on("progress-actual",r=>{this.actualProgress=r.progress,this.progressType=r.type})},removeFile(r,i){i.downloads=i.downloads.filter(s=>`${s.fileName}.${s.fileExtension}`!==r),this.usageOfFiles[r]=this.usageOfFiles[r].filter(s=>s!==i.id),this.usageOfFiles[r].length===0&&delete this.usageOfFiles[r],this.usageOfFiles[r]||(this.downloadFilesForAllVariants=this.downloadFilesForAllVariants.filter(s=>`${s.fileName}.${s.fileExtension}`!==r))},removeFileForAllVariants(r){const i=`${r.fileName}.${r.fileExtension}`,n=this.usageOfFiles[i];n&&(n.forEach(s=>{const u=this.idToIndex[s],a=this.variantGenerationQueue.createQueue[u];a.downloads=a.downloads.filter(f=>`${f.fileName}.${f.fileExtension}`!==i)}),delete this.usageOfFiles[i]),this.downloadFilesForAllVariants=this.downloadFilesForAllVariants.filter(s=>s.id!==r.id)},getList(){if(!this.variantGenerationQueue){this.paginatedVariantArray=[];return}const r=[];this.variantGenerationQueue.createQueue.forEach(s=>{s.options.some(u=>{var f;return(((f=u.entity.translated)==null?void 0:f.name)||u.entity.name).toUpperCase().includes(this.term.toUpperCase())||this.term===""?(r.push(s),!0):!1})});const i=this.page*this.limit-this.limit,n=i+this.limit;this.total=r.length,this.paginatedVariantArray=r.slice(i,n)},handlePageChange(r){this.onPageChange(r),this.getList()},generateVariants(){this.isLoading=!0,this.variantGenerationQueue.createQueue.forEach(r=>{delete r.id,r.productStates.includes("is-download")&&(r.maxPurchase=1,r.minPurchase=1,r.isCloseout=!1,r.shippingFree=!1);const i=[];r.downloads.forEach(n=>{i.push({mediaId:n.id})}),r.downloads=i}),this.variantsGenerator.saveVariants(this.variantGenerationQueue).then(()=>(this.addOriginalConfiguratorSettings(),this.productRepository.save(this.product))).then(()=>{this.$emit("variations-finish-generate"),this.$emit("modal-close"),this.isLoading=!1,this.actualProgress=0,this.maxProgress=0,this.swProductDetailLoadAll()})},showNextStep(){this.isLoading=!0,this.variantsGenerator.generateVariants(this.currencies,this.product,this.isAddOnly),this.isLoading=!1},calcVariantsNumber(){const r=this.product.configuratorSettings.reduce((n,s)=>{const u=s.option.groupId,a=n[u];return a?(a.push(s.option.id),n):(n[u]=[s.option.id],n)},{}),i=Object.values(r);this.variantsNumber=i.length>0?i.map(n=>n.length).reduce((n,s)=>n*s):0},onChangeAllVariantValues(r){let i=this.variantGenerationQueue.createQueue;if(this.term&&(i=this.paginatedVariantArray),!r){this.usageOfFiles={},i.forEach(n=>{n.downloads=[],n.productStates=[]}),this.getList();return}i.forEach(n=>{n.downloads=[...this.downloadFilesForAllVariants],this.updateUsageForAllVariantFiles(n.id),n.productStates=["is-download"]}),this.getList()},onChangeVariantValue(r,i){if(!r){Object.keys(this.usageOfFiles).forEach(n=>{this.usageOfFiles[n]=this.usageOfFiles[n].filter(s=>s!==i.id),this.usageOfFiles[n].length===0&&(delete this.usageOfFiles[n],this.downloadFilesForAllVariants=this.downloadFilesForAllVariants.filter(s=>`${s.fileName}.${s.fileExtension}`!==n))}),i.downloads=[],i.productStates=[];return}i.downloads=[...this.downloadFilesForAllVariants],this.updateUsageForAllVariantFiles(i.id),i.productStates=["is-download"]},isUploadDisabled(r){return r.downloads.length===0},isExistingMedia(r,i){return r.some(({id:n})=>n===i)},successfulUpload(r,i){this.mediaRepository.get(r.targetId,W.api).then(n=>{if(i){if(this.isExistingMedia(i.downloads,r.targetId))return;i.downloads.push(n),this.pushFileToUsageList(`${n.fileName}.${n.fileExtension}`,i.id);return}this.isExistingMedia(this.downloadFilesForAllVariants,r.targetId)||this.downloadFilesForAllVariants.push(n);let s=this.variantGenerationQueue.createQueue;this.term&&(s=this.paginatedVariantArray),s.forEach(u=>{if(u.productStates.includes("is-download")){if(this.isExistingMedia(u.downloads,r.targetId))return;u.downloads.push(n),this.pushFileToUsageList(`${n.fileName}.${n.fileExtension}`,u.id)}})})},updateUsageForAllVariantFiles(r){this.downloadFilesForAllVariants.forEach(i=>{this.pushFileToUsageList(`${i.fileName}.${i.fileExtension}`,r)})},pushFileToUsageList(r,i){this.usageOfFiles[r]||(this.usageOfFiles[r]=[]),this.usageOfFiles[r].push(i)},onModalCancel(){this.addOriginalConfiguratorSettings(),this.$emit("modal-close")},addOriginalConfiguratorSettings(){this.removeDuplicateEntries(),this.originalConfiguratorSettings.forEach(r=>{this.product.configuratorSettings.add(r)}),this.calcVariantsNumber()},emptyConfiguratorSettings(){this.originalConfiguratorSettings=[],this.product.configuratorSettings.getIds().forEach(r=>{this.originalConfiguratorSettings.push(this.product.configuratorSettings.get(r)),this.product.configuratorSettings.remove(r)}),this.calcVariantsNumber()},onTermChange(r){this.term=r,this.getList()},removeDuplicateEntries(){const r=this;this.product.configuratorSettings.getIds().forEach(i=>{const n=r.product.configuratorSettings.get(i);this.originalConfiguratorSettings.find(s=>s.optionId===n.optionId)!==void 0&&r.product.configuratorSettings.remove(i)})}}};export{X as default};
