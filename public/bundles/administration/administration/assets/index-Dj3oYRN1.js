const n=`{% block sw_order_promotion_field %} <div class="sw-order-promotion-field"> {% block sw_order_promotion_field_codes %} <sw-order-promotion-tag-field v-model:value="promotionCodeTags" :disabled="!hasLineItem || isLoading || !acl.can('order.editor') || undefined" :currency="currency" :label="$t('sw-order.detailsTab.promotionsField.labelPromotions')" :placeholder="$t('sw-order.detailsTab.promotionsField.placeholderPromotions')" :error="promotionError" @on-remove-code="onRemoveExistingCode" /> {% endblock %} {% block sw_order_promotion_field_switch %} <h3 class="sw-order-promotion-field__apply_auto_promotions__title"> {{ $t('sw-order.detailsTab.promotionsField.automaticPromotions.title') }} </h3> <p class="sw-order-promotion-field__apply_auto_promotions__text"> {{ $t('sw-order.detailsTab.promotionsField.automaticPromotions.text') }} </p> <mt-button :disabled="isLoading || isOrderLoading || !acl.can('order.editor') || undefined" class="sw-order-promotion-field__apply_auto_promotions__button" variant="secondary" size="default" :is-loading="isOrderLoading || isLoading" @click="applyAutomaticPromotions" > {{ $t('sw-order.detailsTab.promotionsField.automaticPromotions.labelButton') }} </mt-button> {% endblock %} {% block sw_order_promotion_field_updates_modal %} <sw-modal v-if="promotionUpdates.length > 0" class="sw-order-promotion-field__updates_modal" :title="$t('sw-order.detailsTab.promotionsField.updatesModal.title')" @modal-close="dismissPromotionUpdates" > <p class="sw-order-promotion-field__updates_modal__description"> {{ $t('sw-order.detailsTab.promotionsField.updatesModal.description') }} </p> <p v-show="promotionsAdded.length > 0" class="sw-order-promotion-field__updates_modal__list_title" > {{ $t('sw-order.detailsTab.promotionsField.updatesModal.promotionAddedTitle') }} </p> <span v-for="(error, idx) in promotionsAdded" :key="idx" class="sw-order-promotion-field__updates_modal__list_item" > {{ error.parameters.name }} <br> </span> <p v-show="promotionsRemoved.length > 0" class="sw-order-promotion-field__updates_modal__list_title" > {{ $t('sw-order.detailsTab.promotionsField.updatesModal.promotionRemovedTitle') }} </p> <span v-for="(error, idx) in promotionsRemoved" :key="idx" class="sw-order-promotion-field__updates_modal__list_item" > {{ error.parameters.name }} <br> </span> </sw-modal> {% endblock %} </div> {% endblock %}`,{Store:s}=Shopware,{ChangesetGenerator:l}=Shopware.Data,m={template:n,inject:{swOrderDetailOnLoadingChange:{from:"swOrderDetailOnLoadingChange",default:null},swOrderDetailOnError:{from:"swOrderDetailOnError",default:null},swOrderDetailOnReloadEntityData:{from:"swOrderDetailOnReloadEntityData",default:null},swOrderDetailOnSaveAndReload:{from:"swOrderDetailOnSaveAndReload",default:null},swOrderDetailOnSaveAndRecalculate:{from:"swOrderDetailOnSaveAndRecalculate",default:null},swOrderDetailHandleCartErrors:{from:"swOrderDetailHandleCartErrors",default:null},repositoryFactory:{from:"repositoryFactory",default:null},orderService:{from:"orderService",default:null},acl:{from:"acl",default:null}},emits:["error","loading-change","reload-entity-data","save-and-reload","save-and-recalculate"],mixins:["notification"],props:{isLoading:{type:Boolean,required:!1,default:!1}},data(){return{promotionError:null,disabledAutoPromotions:!1,promotionUpdates:[]}},computed:{order(){return s.get("swOrderDetail").order},isOrderLoading:()=>s.get("swOrderDetail").isLoading,versionContext(){return s.get("swOrderDetail").versionContext},orderLineItemRepository(){return this.repositoryFactory.create("order_line_item")},hasLineItem(){return this.order.lineItems.some(e=>e.hasOwnProperty("id"))},currency(){return this.order.currency},manualPromotions(){const e=[];return this.order.lineItems.filter(o=>o.type!=="promotion"||o.referencedId===null||e.includes(o.referencedId)?!1:(e.push(o.referencedId),!0))},automaticPromotions(){return this.order.lineItems.filter(e=>e.type==="promotion"&&e.referencedId===null)},promotionCodeTags:{get(){return this.manualPromotions.map(e=>e.payload)},set(e){const o=this.manualPromotions;if(this.promotionError=null,e.length<o.length)return;const i=o.length,r=e[i];e.length>o.length&&this.onSubmitCode(r.code),i>0&&r.isInvalid&&(this.promotionError={detail:this.$tc("sw-order.createBase.textInvalidPromotionCode")})}},hasAutomaticPromotions(){return this.automaticPromotions.length>0},changesetGenerator(){return new l},hasOrderUnsavedChanges(){return this.changesetGenerator.generate(this.order).changes!==null},promotionsRemoved(){return this.promotionUpdates.filter(e=>e.messageKey==="promotion-discount-deleted")},promotionsAdded(){return this.promotionUpdates.filter(e=>e.messageKey==="promotion-discount-added")}},watch:{disabledAutoPromotions(e,o){o!==this.hasAutomaticPromotions&&this.toggleAutomaticPromotions(e)},automaticPromotions(){this.disabledAutoPromotions=!this.hasAutomaticPromotions}},created(){this.createdComponent()},methods:{createdComponent(){this.disabledAutoPromotions=!this.hasAutomaticPromotions},emitEntityData(){this.swOrderDetailOnReloadEntityData?this.swOrderDetailOnReloadEntityData():this.$emit("reload-entity-data")},emitLoadingChange(e){Shopware.Store.get("swOrderDetail").setLoading(["recalculation",e])},async saveAndReload(e=null){this.swOrderDetailOnSaveAndReload?await this.swOrderDetailOnSaveAndReload(e):this.$emit("save-and-reload",e)},async saveAndRecalculate(){this.swOrderDetailOnSaveAndRecalculate?await this.swOrderDetailOnSaveAndRecalculate():this.$emit("save-and-recalculate")},handleUnsavedOrderChangesResponse(){this.createNotificationWarning({message:this.$tc("sw-order.detailBase.textUnsavedChanges",0)})},handleError(e){Shopware.Store.get("swOrderDetail").setLoading(["recalculation",!1]),this.swOrderDetailOnError?this.swOrderDetailOnError(e):this.$emit("error",e)},deleteAutomaticPromotions(){if(this.automaticPromotions.length===0)return Promise.resolve();const e=this.automaticPromotions.map(o=>this.orderLineItemRepository.delete(o.id,this.versionContext));return Promise.all(e).then(()=>{this.automaticPromotions.forEach(o=>{this.createNotificationSuccess({message:this.$tc("sw-order.detailBase.textPromotionRemoved",{promotion:o.label},0)})})}).catch(this.handleError.bind(this))},async toggleAutomaticPromotions(e){return this.hasOrderUnsavedChanges?(this.handleUnsavedOrderChangesResponse(),this.$nextTick(()=>{this.disabledAutoPromotions=!e}),Promise.resolve()):(Shopware.Store.get("swOrderDetail").setLoading(["recalculation",!0]),await this.saveAndReload(),await this.deleteAutomaticPromotions(),this.orderService.toggleAutomaticPromotions(this.order.id,this.order.versionId,e).then(this.handlePromotionResponse.bind(this)).catch(this.handleError.bind(this)))},async applyAutomaticPromotions(){await this.saveAndReload(()=>this.orderService.applyAutomaticPromotions(this.order.id,this.order.versionId).then(this.handlePromotionResponse.bind(this)).catch(this.handleError.bind(this)))},async onSubmitCode(e){return this.emitLoadingChange(!0),this.saveAndReload(()=>this.orderService.addPromotionToOrder(this.order.id,this.order.versionId,e).then(this.handlePromotionResponse.bind(this)).catch(this.handleError.bind(this)))},handlePromotionResponse(e){var r;if(this.emitEntityData(),Shopware.Store.get("swOrderDetail").setLoading(["recalculation",!1]),typeof((r=e==null?void 0:e.data)==null?void 0:r.errors)!="object")return;const[o,i]=(Array.isArray(e.data.errors)?e.data.errors:Object.values(e.data.errors)).reduce(([t,d],a)=>["promotion-discount-deleted","promotion-discount-added"].includes(a.messageKey)?[t,[...d,a]]:[[...t,a],d],[[],[]]);if(this.promotionUpdates=i,e.data.errors=o,this.swOrderDetailHandleCartErrors){this.swOrderDetailHandleCartErrors(e);return}Object.values(e.data.errors).forEach(t=>{switch(t.level){case 0:{this.createNotificationInfo({message:t.message});break}case 10:{this.createNotificationWarning({message:t.message});break}default:{this.createNotificationError({message:t.message});break}}})},async onRemoveExistingCode(e){Shopware.Store.get("swOrderDetail").setLoading(["recalculation",!0]),this.order.lineItems=this.order.lineItems.filter(o=>o.type!=="promotion"||o.promotionId!==e.promotionId),await this.saveAndRecalculate()},dismissPromotionUpdates(){this.promotionUpdates=[]},getLineItemByPromotionCode(e){return this.order.lineItems.find(o=>o.type==="promotion"&&o.payload.code===e)}}};export{m as default};
